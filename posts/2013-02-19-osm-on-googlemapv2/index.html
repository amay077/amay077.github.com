<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Android API v2 で OpenStreetMap を表示する</title>
    <meta name="description" content="Try and try again">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Experiments Never Fail">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Experiments Never Fail">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Experiments Never Fail</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <!-- Delete this message 
      <div class="warning">
        <ol>
          <li>Edit the <code>_data/metadata.json</code> with your blog’s information.</li>
          <li>(Optional) Edit <code>.eleventy.js</code> with your <a href="https://www.11ty.dev/docs/config/">configuration preferences</a>.</li>
          <li>Delete this message from <code>_includes/layouts/base.njk</code>.</li>
        </ol>
        <p><em>This is an <a href="https://www.11ty.dev/">Eleventy project</a> created from the <a href="https://github.com/11ty/eleventy-base-blog"><code>eleventy-base-blog</code> repo</a>.</em></p>
      </div>
      Stop deleting -->

      <h1>Google Maps Android API v2 で OpenStreetMap を表示する</h1>

<p>この記事は <a href="http://atnd.org/events/34052">FOSS4G Advent Calendar 2012</a> の 12/26 の記事です。</p>
<p>ベクトル地図が扱える新しい Google Maps Android API v2 については、<a href="http://qiita.com/items/7ad0244c0fb4b431e090">Google Map Android API v2 の v1 からの変更点メモ</a> で書きました。</p>
<p>ここでは、v2 で新しく追加された <code>TileOverlay</code> を使って、OpenStreetMap を重ねてみます。</p>
<!-- more -->
<h2 id="urltileprovider-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6-openstreetmap-%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B">UrlTileProvider を使って OpenStreetMap を表示する <a class="direct-link" href="#urltileprovider-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6-openstreetmap-%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B">#</a></h2>
<p>SDK に同梱されるサンプル /extras/google/google_play_services/samples/maps の TileOverlayDemoActivity.java を見れば一目瞭然なので、それをベースにします。</p>
<h3 id="%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89">サンプルのコード <a class="direct-link" href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89">#</a></h3>
<pre class="language-java"><code class="language-java"><span class="token comment">//TileOverlayDemoActivity.java</span><br><span class="token comment">/** This returns moon tiles. */</span><br><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> MOON_MAP_URL_FORMAT <span class="token operator">=</span><br>        <span class="token string">"http://mw1.google.com/mw-planetary/lunar/lunarmaps_v1/clem_bw/%d/%d/%d.jpg"</span><span class="token punctuation">;</span><br><br><span class="token keyword">private</span> <span class="token class-name">GoogleMap</span> mMap<span class="token punctuation">;</span><br><br><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setUpMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    mMap<span class="token punctuation">.</span><span class="token function">setMapType</span><span class="token punctuation">(</span><span class="token class-name">GoogleMap</span><span class="token punctuation">.</span>MAP_TYPE_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">TileProvider</span> tileProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlTileProvider</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token annotation punctuation">@Override</span><br>        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">URL</span> <span class="token function">getTileUrl</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> zoom<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// The moon tile coordinate system is reversed.  This is not normal.</span><br>            <span class="token keyword">int</span> reversedY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> zoom<span class="token punctuation">)</span> <span class="token operator">-</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><br>           <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>US<span class="token punctuation">,</span> MOON_MAP_URL_FORMAT<span class="token punctuation">,</span> zoom<span class="token punctuation">,</span> x<span class="token punctuation">,</span> reversedY<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>            <span class="token keyword">try</span> <span class="token punctuation">{</span><br>                url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">return</span> url<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    mMap<span class="token punctuation">.</span><span class="token function">addTileOverlay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TileOverlayOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tileProvider</span><span class="token punctuation">(</span>tileProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>修正前のコードは、Google Moon のタイル画像を使用しています。</p>
<p>これを OpenStreetMap を使用するように改造します。</p>
<pre class="language-java"><code class="language-java"><span class="token comment">//OsmTileOverlayDemoActivity.java</span><br><span class="token comment">/** This returns moon tiles. */</span><br><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> OSM_MAP_URL_FORMAT <span class="token operator">=</span><br>        <span class="token string">"http://tile.openstreetmap.org/%d/%d/%d.png"</span><span class="token punctuation">;</span><br><br><span class="token keyword">private</span> <span class="token class-name">GoogleMap</span> mMap<span class="token punctuation">;</span><br><br><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setUpMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    mMap<span class="token punctuation">.</span><span class="token function">setMapType</span><span class="token punctuation">(</span><span class="token class-name">GoogleMap</span><span class="token punctuation">.</span>MAP_TYPE_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">TileProvider</span> tileProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlTileProvider</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token annotation punctuation">@Override</span><br>        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">URL</span> <span class="token function">getTileUrl</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> zoom<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>US<span class="token punctuation">,</span> OSM_MAP_URL_FORMAT<span class="token punctuation">,</span> zoom<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>            <span class="token keyword">try</span> <span class="token punctuation">{</span><br>                url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">return</span> url<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    mMap<span class="token punctuation">.</span><span class="token function">addTileOverlay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TileOverlayOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tileProvider</span><span class="token punctuation">(</span>tileProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>できました。うーん、簡単すぎる。<br>
URL は OpenStreetMap のものを使います。y軸の値は、Google Moon では逆順となっていたのを正順のまま使用するだけです。</p>
<p>こんな感じで表示できます。</p>
<p><img src="https://blog.amay0777.net/img/posts/advent2012_osm.png" alt="OpenStreetMap on Google Map API"></p>
<p>移動、拡大・縮小だけでなく、API v2 の恩恵で、回転やチルトもできるのが嬉しいですね。</p>
<h2 id="tileoverlay-%E3%82%92%E9%80%8F%E9%81%8E%E3%81%95%E3%81%9B%E3%82%8B">TileOverlay を透過させる <a class="direct-link" href="#tileoverlay-%E3%82%92%E9%80%8F%E9%81%8E%E3%81%95%E3%81%9B%E3%82%8B">#</a></h2>
<p>さて、ベース地図を Google から他のものに差し替えてしまうならこれまでの使い方で十分でしょう。しかし Google のベクトル3Dグリグリ地図をベース地図として使いたいとは誰しもが思うことでしょう。</p>
<p>ここでは、Google地図の上に TileOverlay を透過で表示することにチャレンジしてみます。<br>
ケースとしては、雨雲レーダーのメッシュや、統計メッシュなどを重ね合わせる事が考えられます。</p>
<p>さて、API v2 のもう一つの新機能 GroundOverlay には [setTransparentcy](<a href="https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/GroundOverlay#setTransparency(float)">https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/GroundOverlay#setTransparency(float)</a> というズバリなメソッドがあり、それを使えば一発です。</p>
<p>しかし、TileOverlay とその関連クラスには、透過に関するメソッドは見当たりません。<br>
そこで TileProvider でダウンロードされた画像データを直接弄って、透過にします。</p>
<p>TileProvider は文字通り <a href="https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/Tile">Tile</a> を Provide します。そしてこの Tile はタイル画像データそのものです。</p>
<p><a href="https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/Tile#data">Tile.data</a> の説明には次のように記述があります。</p>
<blockquote>
<p>A byte array containing the image data. The image will be created from this data by calling [decodeByteArray(byte[], int, int)](<a href="https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/null#decodeByteArray">https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/null#decodeByteArray</a>(byte[], int, int)).</p>
</blockquote>
<p>つまりこのプロパティの中身を透過させてあげれば良さげ、という事になります。</p>
<p>上記のコードで使用した UrlTileProvider の [getTile](<a href="https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/UrlTileProvider#getTile">https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/UrlTileProvider#getTile</a>(int, int, int) を override して…と思ったら、<br>
＿人人人人人人人人人＿<br>
＞　突然の final！　＜<br>
￣^Y^Y^Y^Y^Y^Y^Y^￣<br>
という事で override できません。</p>
<p>仕方ががないので、独自の TileProvider を別途用意して、UrlTileProvider を内包する形で <code>TransparencyUrlTileProvider</code> というクラスを実装します。</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransparencyUrlTileProvider</span> <span class="token keyword">implements</span> <span class="token class-name">TileProvider</span> <span class="token punctuation">{</span><br>	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> OSM_MAP_URL_FORMAT <span class="token operator">=</span> <span class="token string">"http://tile.openstreetmap.org/%d/%d/%d.png"</span><span class="token punctuation">;</span><br><br>	<span class="token keyword">private</span> <span class="token keyword">int</span> _transparency<span class="token punctuation">;</span> <span class="token comment">// 透過率(0〜255)</span><br>	<span class="token keyword">private</span> <span class="token class-name">UrlTileProvider</span> _osmTileProv<span class="token punctuation">;</span> <span class="token comment">// 内包する TileProvider</span><br>	<br>	<span class="token keyword">public</span> <span class="token class-name">TransparencyUrlTileProvider</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> transparency<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		_transparency <span class="token operator">=</span> transparency<span class="token punctuation">;</span><br>		<br>		_osmTileProv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlTileProvider</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token annotation punctuation">@Override</span><br>			<span class="token keyword">public</span> <span class="token class-name">URL</span> <span class="token function">getTileUrl</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> zoom<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	            <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>US<span class="token punctuation">,</span> OSM_MAP_URL_FORMAT<span class="token punctuation">,</span> zoom<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	            <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>	            <span class="token keyword">try</span> <span class="token punctuation">{</span><br>	                url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	            <span class="token punctuation">}</span><br>	            <span class="token keyword">return</span> url<span class="token punctuation">;</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br>	<br>	<span class="token annotation punctuation">@Override</span><br>	<span class="token keyword">public</span> <span class="token class-name">Tile</span> <span class="token function">getTile</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> zoom<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token class-name">Tile</span> tile <span class="token operator">=</span> _osmTileProv<span class="token punctuation">.</span><span class="token function">getTile</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zoom<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<br>		<span class="token comment">// TODO ここで Tile の透過処理を行う</span><br>		<br>		<span class="token keyword">return</span> tile<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br><span class="token punctuation">}</span></code></pre>
<p>使う側は、こんな感じになります。</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">GoogleMap</span> mMap<span class="token punctuation">;</span><br><br><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setUpMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// mMap.setMapType(GoogleMap.MAP_TYPE_NONE); ベース地図は消さない</span><br><br>    mMap<span class="token punctuation">.</span><span class="token function">addTileOverlay</span><span class="token punctuation">(</span><br>        <span class="token keyword">new</span> <span class="token class-name">TileOverlayOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">tileProvider</span><span class="token punctuation">(</span><br>            <span class="token keyword">new</span> <span class="token class-name">TransparencyUrlTileProvider</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>ここまでで改造前と同じく OpenStreetMap が「非透過で」表示されるのは確認できます。</p>
<p>次にいよいよ Bitmap の透過処理です。<br>
まず、Tile から Bitmap を抜き出します。API リファレンスによると、<a href="https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/model/Tile#data">Tile.data</a> というメンバがあるハズが…見つかりません。代わりに <code>Tile.bM</code> という byte[] なメンバがあります。こいつで間違いないでしょう。</p>
<h3 id="2013.4.22-%E8%BF%BD%E8%A8%98">2013.4.22 追記 <a class="direct-link" href="#2013.4.22-%E8%BF%BD%E8%A8%98">#</a></h3>
<p>Tile.data が見つからないのは、どうやらバグのようです。間違えて Proguard で難読化されてしまったようです。</p>
<ul>
<li><a href="https://code.google.com/p/gmaps-api-issues/issues/detail?id=5082">Issue 5082 - gmaps-api-issues - Bug: Public field &quot;data&quot; in Tile wrongly obfuscated - Google Maps API bug reports and feature requests</a></li>
</ul>
<h3 id="2013.4.22-%E8%BF%BD%E8%A8%98%E7%B5%82%E3%82%8F%E3%82%8A">2013.4.22 追記終わり <a class="direct-link" href="#2013.4.22-%E8%BF%BD%E8%A8%98%E7%B5%82%E3%82%8F%E3%82%8A">#</a></h3>
<p><a href="http://Tile.bM">Tile.bM</a> の byte[] から Bitmap インスタンスを生成します。</p>
<pre><code>Bitmap bitmap = BitmapFactory.decodeByteArray(tile.bM, 0, tile.bM.length);
</code></pre>
<p>次に透過処理ですが、Android ではちょっと面倒なようです。<br>
以下のサイトを参考にさせて頂いて、関数を作成しました。</p>
<ul>
<li><a href="http://d.hatena.ne.jp/hypercrab/20110730/1312038162">Android: Bitmap の背景を透明にする - 入隠者通信 ～病を嗜む～</a></li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Bitmap</span> <span class="token function">makeTransparentBmp</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Bitmap</span> bmp<span class="token punctuation">,</span> <span class="token keyword">int</span> transparency<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>     <span class="token keyword">int</span> width <span class="token operator">=</span> bmp<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br>     <span class="token keyword">int</span> height <span class="token operator">=</span> bmp<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br>     <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pixels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>width <span class="token operator">*</span> height<span class="token punctuation">]</span><span class="token punctuation">;</span> <br><br>     <span class="token class-name">Bitmap</span> bitmap <span class="token operator">=</span> <span class="token class-name">Bitmap</span><span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span>height<span class="token punctuation">,</span><span class="token class-name">Bitmap<span class="token punctuation">.</span>Config</span><span class="token punctuation">.</span>ARGB_8888 <span class="token punctuation">)</span><span class="token punctuation">;</span><br>     bmp<span class="token punctuation">.</span><span class="token function">getPixels</span><span class="token punctuation">(</span>pixels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span> <br>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <br>       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <br>      	 <span class="token keyword">int</span> pixel <span class="token operator">=</span> pixels<span class="token punctuation">[</span>x <span class="token operator">+</span> y <span class="token operator">*</span> width<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      	 pixels<span class="token punctuation">[</span>x <span class="token operator">+</span> y <span class="token operator">*</span> width<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">argb</span><span class="token punctuation">(</span>transparency<span class="token punctuation">,</span> <br>      			 <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span>pixel<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span>pixel<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">blue</span><span class="token punctuation">(</span>pixel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br>       <span class="token punctuation">}</span> <br>     <span class="token punctuation">}</span> <br>     bitmap<span class="token punctuation">.</span><span class="token function">eraseColor</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">argb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br>     bitmap<span class="token punctuation">.</span><span class="token function">setPixels</span><span class="token punctuation">(</span>pixels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span> <br>     <br>     <span class="token keyword">return</span> bitmap<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>では TODO の所に組み込みます。</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransparencyUrlTileProvider</span> <span class="token keyword">implements</span> <span class="token class-name">TileProvider</span> <span class="token punctuation">{</span><br><br>    <span class="token operator">&lt;</span>前略<span class="token operator">></span><br>	<br>	<span class="token annotation punctuation">@Override</span><br>	<span class="token keyword">public</span> <span class="token class-name">Tile</span> <span class="token function">getTile</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> zoom<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token class-name">Tile</span> tile <span class="token operator">=</span> _osmTileProv<span class="token punctuation">.</span><span class="token function">getTile</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zoom<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<br>		<span class="token comment">// Tile の透過処理を行う</span><br>       <span class="token class-name">Bitmap</span> bmp <span class="token operator">=</span> <span class="token class-name">BitmapFactory</span><span class="token punctuation">.</span><span class="token function">decodeByteArray</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>bM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tile<span class="token punctuation">.</span>bM<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><br>       <span class="token class-name">Bitmap</span> transparentBmp <span class="token operator">=</span> <span class="token function">makeTransparentBmp</span><span class="token punctuation">(</span>bmp<span class="token punctuation">,</span> _transparency<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>       <span class="token comment">// Tile を作り直す</span><br>		<span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		transparentBmp<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span><span class="token class-name">CompressFormat</span><span class="token punctuation">.</span>PNG<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> bos<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token class-name">Tile</span> tranparentTile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tile</span><span class="token punctuation">(</span>tile<span class="token punctuation">.</span>width<span class="token punctuation">,</span> tile<span class="token punctuation">.</span>height<span class="token punctuation">,</span> bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<br>		<span class="token keyword">return</span> tranparentTile<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token operator">&lt;</span>以下略<span class="token operator">></span><br><span class="token punctuation">}</span></code></pre>
<p>動かしてみます。</p>
<p><img src="https://blog.amay0777.net/img/posts/advent2012_osmwithg.png" alt="OpenStreetMap with Google Map API"></p>
<p>これは、GoogleMap の衛星写真の上に OpenStreetMap を透過して重ねた例です（分かりづらい</p>
<h2 id="%E3%81%BE%E3%81%A8%E3%82%81">まとめ <a class="direct-link" href="#%E3%81%BE%E3%81%A8%E3%82%81">#</a></h2>
<p>このように Google Maps Android API v2 では、TileProvider を使って、タイル地図画像を簡単に表示させることができます。</p>
<p>Google Maps Javascript API や、MapKit でも他のタイル地図画像を利用することはできましたが、それらよりもより簡単に使えます。ハックというよりも API が公式にサポートしている、という感じです。</p>
<p>これまで Android には、Javascript の OpenLayers や、 iOS の route-me のような、地図タイルデータソースを扱える地図SDKはありませんでした（いや OsmDroid くらいか）</p>
<p>それを Google Maps Android API v2 がサポートしたのですから使わない手はありません。地図SDK としては一番高性能で事実上標準なのですから。</p>
<p>これに、OpenStreetMap や電子国土地図、衛星画像などの背景地図や、統計データメッシュや、アメダスなどの主題図的なタイル地図が重ねられるといろいろできそうだなあ、という感じです。<br>
(Yahoo! さんの<a href="http://weather.yahoo.co.jp/weather/zoomradar/">雨雲レーダー</a> のタイル画像もこっそり試してみて「こりゃ面白い」と思ったので公式に提供して欲しいですｗ)</p>
<p>私にはタイル地図データを作る知識は無いので、タイル地図のポータルみたいなものがあるといいなあと思います。 <a href="https://www.facebook.com/chitaikyo">地図タイル工法協会</a> さんよろしくおねがいします。</p>
<p>というわけで、Android で地図使いたいなら(今のところ) Google Maps API v2 一択！ 他社さんもガンバレ！</p>
<p>※あれ？このネタどこが FOSS4G だ？ま、いっか。</p>


published at <time class="postlist-date" datetime="2012-12-26">26 Dec 2012</time>

tags: 

  <a href="/tags/Android/" class="post-tag">Android</a>
  <a href="/tags/GoogleMapsAPI/" class="post-tag">GoogleMapsAPI</a>
  <a href="/tags/OpenStreetMap/" class="post-tag">OpenStreetMap</a>

<hr>
<ul><li>Next: <a href="/posts/2013-02-19-gets-context-on-android-junit/">Android の jUnit テストで Context が欲しい時</a></li><li>Previous: <a href="/posts/2013-02-19-edittext-ontextchanged/">Android/EditTextでIMEの未確定文字列が確定された瞬間(のフォーク)</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /posts/2013-02-19-osm-on-googlemapv2/ -->
  </body>
</html>
