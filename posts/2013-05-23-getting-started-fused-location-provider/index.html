<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google I/O 2013 で発表された Fused Location Provider を使ってみる</title>
    <meta name="description" content="Try and try again">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Experiments Never Fail">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Experiments Never Fail">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Experiments Never Fail</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <!-- Delete this message 
      <div class="warning">
        <ol>
          <li>Edit the <code>_data/metadata.json</code> with your blog’s information.</li>
          <li>(Optional) Edit <code>.eleventy.js</code> with your <a href="https://www.11ty.dev/docs/config/">configuration preferences</a>.</li>
          <li>Delete this message from <code>_includes/layouts/base.njk</code>.</li>
        </ol>
        <p><em>This is an <a href="https://www.11ty.dev/">Eleventy project</a> created from the <a href="https://github.com/11ty/eleventy-base-blog"><code>eleventy-base-blog</code> repo</a>.</em></p>
      </div>
      Stop deleting -->

      <h1>Google I/O 2013 で発表された Fused Location Provider を使ってみる</h1>

<p><a href="http://amay077.github.io/blog/2013/05/18/getting-started-activity-recognition/">Activity Recognition</a> に続いて使ってみました。</p>
<!--more-->
<h2 id="fused-location-provider-%E3%81%A8%E3%81%AF%EF%BC%9F">Fused Location Provider とは？ <a class="direct-link" href="#fused-location-provider-%E3%81%A8%E3%81%AF%EF%BC%9F">#</a></h2>
<p>GPS と WiFi とセンサー(加速度など) を組み合わせて、その状況に応じた最適な方法で位置を取得出来ます。今までよりも低消費電力で、精度のよい位置情報を。</p>
<p>実際どんな感じかは、Google I/O 2013 のセッション動画にある <a href="http://www.youtube.com/watch?feature=player_detailpage&amp;v=URcVZybzMUI#t=733s">Fused Location Provider のデモ</a> を見てください。</p>
<p>次から使い方です。</p>
<h2 id="1.-sdk-%E3%81%AE-google-play-services-%E3%82%92%E6%9B%B4%E6%96%B0%E3%81%99%E3%82%8B">1. SDK の Google Play Services を更新する <a class="direct-link" href="#1.-sdk-%E3%81%AE-google-play-services-%E3%82%92%E6%9B%B4%E6%96%B0%E3%81%99%E3%82%8B">#</a></h2>
<p><img src="/img/posts/getting_started_activity_recognition1.png" alt="image1"></p>
<p>Activity Recognition と同じく Google Play services として提供されているので、SDK Manager でライブラリを更新します。</p>
<h2 id="2.-eclipse-%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B">2. Eclipse でプロジェクトを作る <a class="direct-link" href="#2.-eclipse-%E3%81%A7%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B">#</a></h2>
<p>Android Studio は使ってません(まだよくわからないので)<br>
Eclipse で、いつもどおりに Android のプロジェクトを作ります。<br>
Fragment も使いませんよ、古きよき、BlankActivity なプロジェクトです。<br>
名前はここでは FusedLocationProviderSample とします。</p>
<h2 id="3.-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB-google-play-services_lib-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">3. プロジェクトに google-play-services_lib を追加する <a class="direct-link" href="#3.-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB-google-play-services_lib-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">#</a></h2>
<p>Google Play services を使うために、SDK のフォルダにある google-play-services_lib が必要です。</p>
<p>Ecplise の Import で <code>{your sdk location}/extras/google/google_play_services/libproject/google-play-services_lib</code> を選択します。自分の Workspace に Copy しておいた方が無難でしょう。</p>
<p>コピーしたら、FusedLocationProviderSample で、 google-play-services_lib をライブラリ参照します。</p>
<p><img src="/img/posts/getting_started_activity_recognition2.png" alt="image2"></p>
<p>次から FusedLocationProviderSample の実装です。</p>
<h2 id="4.-androidmanifest.xml-%E3%81%AE%E7%B7%A8%E9%9B%86">4. AndroidManifest.xml の編集 <a class="direct-link" href="#4.-androidmanifest.xml-%E3%81%AE%E7%B7%A8%E9%9B%86">#</a></h2>
<p>Fused Location Provider を使うのには今まで通り、<code>ACCESS_FINE_LOCATION</code> と <code>ACCESS_COARSE_LOCATION</code> を設定します。</p>
<p>LocationClient は、指定した PERMISSION に応じてよしなに動いてくれるそうです。</p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span><br>    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.fusedlocationprovidersample<span class="token punctuation">"</span></span><br>    <span class="token attr-name"><span class="token namespace">android:</span>versionCode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><br>    <span class="token attr-name"><span class="token namespace">android:</span>versionName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-sdk</span><br>        <span class="token attr-name"><span class="token namespace">android:</span>minSdkVersion</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>targetSdkVersion</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>17<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.ACCESS_FINE_LOCATION<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.ACCESS_COARSE_LOCATION<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span><br>        <span class="token attr-name"><span class="token namespace">android:</span>allowBackup</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@drawable/ic_launcher<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@style/AppTheme<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span><br>            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.fusedlocationprovidersample.MainActivity<span class="token punctuation">"</span></span><br>            <span class="token attr-name"><span class="token namespace">android:</span>screenOrientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>portrait<span class="token punctuation">"</span></span><br>            <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span><br><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span></code></pre>
<h2 id="5.-fused-location-provider-%E3%82%92%E4%BD%BF%E3%81%86">5. Fused Location Provider を使う <a class="direct-link" href="#5.-fused-location-provider-%E3%82%92%E4%BD%BF%E3%81%86">#</a></h2>
<p>ActivityRecognition は IntentService を使う必要があったために少々長いコードになりましたが、こちらは今までの <code>LocationProvider</code> が(も)使えるので、画面一つだけのシンプルなコードです。</p>
<p>FusedLocationProvider を使うには、<a href="http://developer.android.com/reference/com/google/android/gms/location/LocationClient.html">LocationClient</a> クラスを使います。</p>
<p>大雑把な流れは:</p>
<ol>
<li>インスタンスを生成する<br>
connect を呼ぶ -&gt; ConnectionCallbacks.onConnected がコールバックされる</li>
<li><a href="http://developer.android.com/reference/com/google/android/gms/location/LocationRequest.html">LocationRequest</a> を指定して、requestLocationUpdates を呼ぶ。 -&gt; LocationListener.onLocationChanged が呼ばれる</li>
</ol>
<p>です。connect を呼んで onConnected を待つのと、位置取得条件が <code>LocationRequest</code> クラスになった以外は <code>LocationManager</code> と同じです。</p>
<p>では、全コードです。</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>fusedlocationprovidersample</span><span class="token punctuation">;</span><br><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">ConnectionResult</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">GooglePlayServicesClient<span class="token punctuation">.</span>ConnectionCallbacks</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">GooglePlayServicesClient<span class="token punctuation">.</span>OnConnectionFailedListener</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token punctuation">.</span>location<span class="token punctuation">.</span></span><span class="token class-name">LocationClient</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token punctuation">.</span>location<span class="token punctuation">.</span></span><span class="token class-name">LocationListener</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token punctuation">.</span>location<span class="token punctuation">.</span></span><span class="token class-name">LocationRequest</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>location<span class="token punctuation">.</span></span><span class="token class-name">Location</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>text<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span><span class="token class-name">DateFormat</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">View</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span></span><span class="token class-name">Button</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span></span><span class="token class-name">TextView</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">Activity</span><span class="token punctuation">;</span><br><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span><br>	<br>	<span class="token comment">// FusedLocationProvider 用の Client</span><br>	<span class="token keyword">private</span> <span class="token class-name">LocationClient</span> _locationClient<span class="token punctuation">;</span><br>	<span class="token keyword">private</span> <span class="token class-name">TextView</span> _textResult<span class="token punctuation">;</span><br>	<br>	<span class="token comment">// 以前と変わらない LocationListener</span><br>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LocationListener</span> _locationListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<br>		<span class="token annotation punctuation">@Override</span><br>		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLocationChanged</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Location</span> location<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>				<span class="token annotation punctuation">@Override</span><br>				<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>					<span class="token class-name">String</span> text <span class="token operator">=</span> _textResult<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		            text <span class="token operator">=</span> <span class="token class-name">DateFormat</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"hh:mm:ss.sss"</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" - "</span> <br>		                    <span class="token operator">+</span> location<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span><br>		                    <span class="token operator">+</span> location<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span><br>		                    <span class="token operator">+</span> location<span class="token punctuation">.</span><span class="token function">getAccuracy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <br>		                    <span class="token string">"\n"</span> <span class="token operator">+</span> text<span class="token punctuation">;</span><br><br>		            _textResult<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span><br>				<span class="token punctuation">}</span><br>			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">;</span><br>	<br>	<span class="token annotation punctuation">@Override</span><br>	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<br>		_textResult <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TextView</span><span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>text_result<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<br>		<span class="token keyword">final</span> <span class="token class-name">Button</span> buttonLocate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Button</span><span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>button_locate<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		buttonLocate<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token keyword">private</span> <span class="token keyword">boolean</span> _isStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>			<br>			<span class="token annotation punctuation">@Override</span><br>			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>					<span class="token function">startLocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>					buttonLocate<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Stop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>					<span class="token function">stopLocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>					buttonLocate<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>				<span class="token punctuation">}</span><br>				<br>				_isStarted <span class="token operator">=</span> <span class="token operator">!</span>_isStarted<span class="token punctuation">;</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br>	<br>	<span class="token annotation punctuation">@Override</span><br>	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token function">stopLocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br>	<br>	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startLocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		_locationClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocationClient</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>			<span class="token annotation punctuation">@Override</span><br>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnected</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> bundle<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>				<span class="token comment">// 2. 位置の取得開始！</span><br>				<span class="token class-name">LocationRequest</span> request <span class="token operator">=</span> <span class="token class-name">LocationRequest</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>				<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token class-name">LocationRequest</span><span class="token punctuation">.</span>PRIORITY_HIGH_ACCURACY<span class="token punctuation">)</span><br>				<span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5秒おき</span><br>            	_locationClient<span class="token punctuation">.</span><span class="token function">requestLocationUpdates</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> _locationListener<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token annotation punctuation">@Override</span><br>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDisconnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            	_locationClient <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OnConnectionFailedListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token annotation punctuation">@Override</span><br>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionFailed</span><span class="token punctuation">(</span><span class="token class-name">ConnectionResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<br>		<span class="token comment">// 1. 位置取得サービスに接続！</span><br>		_locationClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">stopLocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>_locationClient <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>_locationClient<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token keyword">return</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><br>		<br>		_locationClient<span class="token punctuation">.</span><span class="token function">removeLocationUpdates</span><span class="token punctuation">(</span>_locationListener<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		_locationClient<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token comment">// ConnectionCallbacks.onDisconnected が呼ばれるまで待った方がいい気がする</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="6.-%E5%8B%95%E3%81%8F%E3%81%AE%E3%81%8B%EF%BC%81%EF%BC%9F">6. 動くのか！？ <a class="direct-link" href="#6.-%E5%8B%95%E3%81%8F%E3%81%AE%E3%81%8B%EF%BC%81%EF%BC%9F">#</a></h2>
<p>HTC J(not蝶) で動かしてみました。</p>
<p><img src="/img/posts/getting_started_fused_location_provider1.png" alt="image3"></p>
<p>室内での結果ですが、最初 27m の精度だったのが、放っておくとどんどん精度が上がって行きました。が、地図に重ねてみないと実際合ってるのかよくわかりませんね。</p>
<p>そのうち、地図に載せて検証してみたいです。</p>
<h2 id="permission-%E3%81%A8-priority-%E3%81%A8%E7%B2%BE%E5%BA%A6%E3%81%AE%E8%A9%B1">Permission と Priority と精度の話 <a class="direct-link" href="#permission-%E3%81%A8-priority-%E3%81%A8%E7%B2%BE%E5%BA%A6%E3%81%AE%E8%A9%B1">#</a></h2>
<p>Permission と Priority の組み合わせで、位置の精度がどう変わるか、少し調べました。</p>
<h3 id="fine_location%2Bcoarse_location-with-priority_high_accuracy">FINE_LOCATION+COARSE_LOCATION with PRIORITY_HIGH_ACCURACY <a class="direct-link" href="#fine_location%2Bcoarse_location-with-priority_high_accuracy">#</a></h3>
<p>GPS と WiFi と センサーフル活用。GPS が捕捉できなくても数十ｍの位置精度が概ね出るようです。</p>
<h3 id="coarse_location-with-priority_high_accuracy">COARSE_LOCATION with PRIORITY_HIGH_ACCURACY <a class="direct-link" href="#coarse_location-with-priority_high_accuracy">#</a></h3>
<p>使えない。FINE_LOCATION が必要ってエラーになりました。</p>
<h3 id="coarse_location-with-priority_balanced_power_accuracy">COARSE_LOCATION with  PRIORITY_BALANCED_POWER_ACCURACY <a class="direct-link" href="#coarse_location-with-priority_balanced_power_accuracy">#</a></h3>
<p>位置の精度が数km程度になりました。WiFi測位(従来の NETWORK_PROVIDER)よりも悪いです。うーんこれは期待はずれだなあ。</p>
<p>結局、例えば屋内測位でしか使わないからGPS要らねって FINE_LOCATION を外すと、かえって精度が落ちるという事になります。(GPS使いませんPERMISSIONが欲しいな。。。)</p>
<h2 id="%E3%81%8A%E3%81%BE%E3%81%91">おまけ <a class="direct-link" href="#%E3%81%8A%E3%81%BE%E3%81%91">#</a></h2>
<ul>
<li><a href="https://developers.google.com/maps/documentation/android/releases#may_2013">Google Maps Android API v2 Release Notes - Google Maps Android API v2 — Google Developers</a></li>
</ul>
<p>によると、Google Maps Android API v2 の [setMyLocationEnabled(true)](<a href="https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/GoogleMap#setMyLocationEnabled(boolean)">https://developers.google.com/maps/documentation/android/reference/com/google/android/gms/maps/GoogleMap#setMyLocationEnabled(boolean)</a> でも FusedLocationProvider が使われるようになったとのことです。</p>
<h2 id="%E3%81%BE%E3%81%A8%E3%82%81">まとめ <a class="direct-link" href="#%E3%81%BE%E3%81%A8%E3%82%81">#</a></h2>
<p>公式のコンプリートな Getting Started は</p>
<ul>
<li><a href="http://developer.android.com/training/location/retrieve-current.html">Retrieving the Current Location ｜ Android Developers</a></li>
</ul>
<p>にありますので、こちらを読まれた方が確実です。</p>
<p>ここで作ったサンプルは、</p>
<ul>
<li><a href="https://github.com/amay077/fusedlocationprovidersample">amay077/fusedlocationprovidersample · GitHub</a></li>
</ul>
<p>に置いておきます。</p>


published at <time class="postlist-date" datetime="2013-05-23">23 May 2013</time>

tags: 

  <a href="/tags/Android/" class="post-tag">Android</a>
  <a href="/tags/GoogleMapsAPI/" class="post-tag">GoogleMapsAPI</a>

<hr>
<ul><li>Next: <a href="/posts/2013-05-27-fused-location-provider-on-xamarin/">Xamarin.Android で Fused Location Provider(など)を使う</a></li><li>Previous: <a href="/posts/2013-05-20-digest-of-android-location-session-in-google-io2013/">Google I/O 2013 の Android Location セッションまとめ</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /posts/2013-05-23-getting-started-fused-location-provider/ -->
  </body>
</html>
