---
layout: post
title: "Xamarin.iOS で特定の画面だけ向きを固定する時ハマったこと"
date: 2014-01-07 18:11
comments: true
categories: [Xamarin, iOS, C#]
---
画面A,B があって B だけ横向き固定にしたい。

* [uiviewcontroller - iOS 6 ViewController is rotating but shouldn't - Stack Overflow](http://stackoverflow.com/a/12588038)
* [iPhone - UIViewController iOS6での画面回転への対応 - Qiita [キータ]](http://qiita.com/yusuga_/items/8cc82376edb40e09f0e7)

これを Xamarin.iOS でやりたい。
<!--more-->
Storyboard を Interface Builder で開いて、NavigationController のカスタムクラスを ``MyNavigationController`` とした。

![](https://dl.dropboxusercontent.com/u/264530/qiita/viewcontroller_orientaion_lock_in_xamarin_ios_01.png)

すると、Xamarin Studio 側にも ``MyNavigationController.cs`` ができるので、Stackoverflow の通り、以下のように実装した。

```csharp MyNavigationController.cs
// This file has been autogenerated from a class added in the UI designer.

using System;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using System.Linq;

namespace MyApp
{
	public partial class MyNavigationController : UINavigationController
	{
		public MyNavigationController (IntPtr handle) : base (handle) { }

        public override UIInterfaceOrientation PreferredInterfaceOrientationForPresentation()
        {
            return this.ViewControllers.Last().PreferredInterfaceOrientationForPresentation();
        }

        public override UIInterfaceOrientationMask GetSupportedInterfaceOrientations()
        {
            return this.ViewControllers.Last().GetSupportedInterfaceOrientations();
        }

        public override bool ShouldAutorotate()
        {
            return this.ViewControllers.Last().ShouldAutorotate();
        }

	}
}
```

次に、横固定にしたい画面Bを以下のように実装。

```csharp BViewController.cs
// This file has been autogenerated from a class added in the UI designer.

using System;

using MonoTouch.Foundation;
using MonoTouch.UIKit;

namespace MyApp
{
	public partial class BViewController : UIViewController
	{
		public PhotoPreviewViewController (IntPtr handle) : base (handle)
		{
		}

        public override UIInterfaceOrientation PreferredInterfaceOrientationForPresentation()
        {
            return UIInterfaceOrientation.LandscapeLeft;
        }

        public override UIInterfaceOrientationMask GetSupportedInterfaceOrientations()
        {
            return UIInterfaceOrientationMask.LandscapeLeft;
        }

        public override bool ShouldAutorotate()
        {
            return false;
        }
	}
}
```

これで動かしてみたものの、一向に画面が固定されない。
しばらく悩んだ後、``MyNavigationController`` のコンストラクタにブレークポイントを仕掛けてデバッグしてみたとても止まらない。
よくよくアプリケーション出力のコンソールを見てみると、

> Unknown class MyNavigationController in InterfaceBuilder file."

と出力されていることに気づいた。
なんか、.storyboard と C# クラスの関連付けがうまくいってないらしい。

ソリューションをクリアして、再ビルドしたらこのエラーは消え、画面Bの向きが固定されるようになった！

(ただ、縦画面のまま画面Bに遷移すると縦画面で固定されてしまう。これは実装が何か足りない気がする。)