<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xamarin.Android で画面遷移時にデータを渡す</title>
    <meta name="description" content="Try and try again">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Experiments Never Fail">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Experiments Never Fail">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-224332-7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-224332-7');
    </script>
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Experiments Never Fail</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <!-- Delete this message 
      <div class="warning">
        <ol>
          <li>Edit the <code>_data/metadata.json</code> with your blog’s information.</li>
          <li>(Optional) Edit <code>.eleventy.js</code> with your <a href="https://www.11ty.dev/docs/config/">configuration preferences</a>.</li>
          <li>Delete this message from <code>_includes/layouts/base.njk</code>.</li>
        </ol>
        <p><em>This is an <a href="https://www.11ty.dev/">Eleventy project</a> created from the <a href="https://github.com/11ty/eleventy-base-blog"><code>eleventy-base-blog</code> repo</a>.</em></p>
      </div>
      Stop deleting -->

      <h1>Xamarin.Android で画面遷移時にデータを渡す</h1>

<p><a href="http://amay077.github.io/blog/2013/02/28/helloworld-on-xamarin-android/">前回のポスト</a>で HelloWorld を見てみましたが、次は Activity をもう一つ作って画面遷移してみます。</p>
<!-- more -->
<h2 id="activity-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">Activity を追加する <a class="direct-link" href="#activity-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">#</a></h2>
<p>メニュー → 新規 → ファイル と選択するとこんなダイアログが出るので Activity クラス名を入力して決定します。</p>
<p><img src="https://blog.amay0777.net/img/posts/xamarin_percelable_create_activity.png" alt="&quot;new_file_dialog&quot;"></p>
<p>すると <code>NextActivity.cs</code> ができます。</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span><br><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>App</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>Content</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>OS</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>Runtime</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>Views</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>Widget</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token namespace">HelloXamarinAndroid</span><br><span class="token punctuation">{</span><br>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Activity</span> <span class="token attribute-arguments"><span class="token punctuation">(</span>Label <span class="token operator">=</span> <span class="token string">"NextActivity"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>			<br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NextActivity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Activity</span></span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> bundle<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnCreate</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token comment">// Create your application here</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>作ってくれるのはここまでです。レイアウト用の Next.axml やリソースファイルは別途作成する必要があります。今回は必要ないのでスルーで。</p>
<p>Android本家だと今はウィザードで Javaソース、レイアウトXML、リソースファイルまで作ってくれてしかも AndroidManifest.xml にも書いてくれちゃいます、便利な世の中になりましたね。</p>
<p>ちなみに Xamarin.Android では AndroidManifest.xml への登録は必要ありません。</p>
<h2 id="%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">画面遷移してみる <a class="direct-link" href="#%E7%94%BB%E9%9D%A2%E9%81%B7%E7%A7%BB%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">#</a></h2>
<p>画面遷移は本家と同じく Intent を使います。</p>
<pre class="language-csharp"><code class="language-csharp">button<span class="token punctuation">.</span>Click <span class="token operator">+=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=></span> <br><span class="token punctuation">{</span><br>    <span class="token comment">// Goto NextActivity</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">NextActivity</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">StartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>本家だと <code>NextActivity.class</code> としていたところは <code>typeof(NextActivity)</code> になってますね。</p>
<h2 id="%E8%87%AA%E4%BD%9C%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92-intent-%E3%81%AB%E5%90%AB%E3%82%81%E3%82%8B">自作クラスを Intent に含める <a class="direct-link" href="#%E8%87%AA%E4%BD%9C%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92-intent-%E3%81%AB%E5%90%AB%E3%82%81%E3%82%8B">#</a></h2>
<p>さて、画面遷移時にデータを渡すという、よくある処理をやってみたいと思います。<br>
データは <code>Card</code> というクラスにします。</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> <span class="token namespace">HelloXamarinAndroid</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">class</span> <span class="token class-name">Card</span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Phone <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Csharp なので、プロパティ作るのも楽でいいですね。getter/setter なんてアホらしくて…。<br>
この Card クラスのインスタンスを、MainActivity から NextActivity に渡したいと思います。</p>
<h2 id="iparcelable-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%9F%E3%81%84%E3%81%8C%EF%BC%9F">IParcelable を実装したいが？ <a class="direct-link" href="#iparcelable-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%9F%E3%81%84%E3%81%8C%EF%BC%9F">#</a></h2>
<p>Android では、Activity とか Service をまたぐオブジェクトは Percelable インターフェースを実装しなければならないのでした。<br>
「じゃあ Xamarin では？」「IParcelable でしょ」というわけで <code>IParcelable</code> インターフェースを実装するわけですが、こいつが <code>IDisposable</code> や <code>IJavaObject</code> を継承していてこれらも実装させられます。</p>
<p>なんか違う・・・とあきらめてググったところ、こんなんでました。</p>
<ul>
<li><a href="http://dan.clarke.name/2012/09/implementing-iparcelable-in-mono-for-android/">Implementing IParcelable in Mono for Android » Dan Clarke</a></li>
</ul>
<p>以降、これに習うことにします。</p>
<h3 id="mono.android.export-%E3%82%92%E5%8F%82%E7%85%A7%E3%81%AB%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">Mono.Android.Export を参照に追加する <a class="direct-link" href="#mono.android.export-%E3%82%92%E5%8F%82%E7%85%A7%E3%81%AB%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">#</a></h3>
<p>いきなりこれを忘れて、謎のビルドエラーと１０分程格闘しました(汗)</p>
<p><img src="https://blog.amay0777.net/img/posts/xamarin_assenbly_reference.png" alt="&quot;assembly_reference&quot;"></p>
<p>ソリューションツリーの参照の右クリックメニューからアセンブリ参照ダイアログが出るので、<code>Mono.Android.Export</code> を見つけて追加します。</p>
<h4 id="free-%E7%89%88%E3%81%A7%E4%BD%BF%E3%81%A3%E3%81%A6%E3%82%8B%E4%BA%BA%E3%81%AF%E3%81%93%E3%81%93%E3%81%A7%E3%80%8Ctrial-%E3%81%99%E3%82%8B%E3%81%8B%E3%80%81%E8%B2%B7%E3%81%86%E3%81%8B%E3%80%81%E3%81%A9%E3%81%A3%E3%81%A1%E3%81%8B%E3%81%AB%E3%81%9B%E3%81%84%E3%82%84%E3%80%8D%E3%81%A8%E8%A8%80%E3%82%8F%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82">Free 版で使ってる人はここで「Trial するか、買うか、どっちかにせいや」と言われます。 <a class="direct-link" href="#free-%E7%89%88%E3%81%A7%E4%BD%BF%E3%81%A3%E3%81%A6%E3%82%8B%E4%BA%BA%E3%81%AF%E3%81%93%E3%81%93%E3%81%A7%E3%80%8Ctrial-%E3%81%99%E3%82%8B%E3%81%8B%E3%80%81%E8%B2%B7%E3%81%86%E3%81%8B%E3%80%81%E3%81%A9%E3%81%A3%E3%81%A1%E3%81%8B%E3%81%AB%E3%81%9B%E3%81%84%E3%82%84%E3%80%8D%E3%81%A8%E8%A8%80%E3%82%8F%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82">#</a></h4>
<p>Free 版はプログラムのサイズに制限があるのですが、アセンブリを追加することでその制限を超えてしまうものと思われます。</p>
<h3 id="iparcelable-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B">IParcelable を実装する <a class="direct-link" href="#iparcelable-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B">#</a></h3>
<p>Card クラスを、<code>IParcelable</code> を実装するのと共に <code>Java.Lang.Object</code> から派生させます。<br>
あーそういうことですか。</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> <span class="token namespace">HelloXamarinAndroid</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">class</span> <span class="token class-name">Card</span>  <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Java<span class="token punctuation">.</span>Lang<span class="token punctuation">.</span>Object</span><span class="token punctuation">,</span> <span class="token class-name">IParcelable</span></span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Phone <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br><br>        <span class="token keyword">public</span> <span class="token function">Card</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> phone<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> name<span class="token punctuation">;</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>Phone <span class="token operator">=</span> phone<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token preprocessor property">#<span class="token directive keyword">region</span> IParcelable implementation</span><br><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">DescribeContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteToParcel</span><span class="token punctuation">(</span><span class="token class-name">Parcel</span> dest<span class="token punctuation">,</span> <span class="token class-name">ParcelableWriteFlags</span> flags<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            dest<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            dest<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Phone<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>まだ何か足りません。あ、CREATOR だ。</p>
<h2 id="creator-%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%82%92%E6%BA%96%E5%82%99%E3%81%99%E3%82%8B">CREATOR フィールドを準備する <a class="direct-link" href="#creator-%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%82%92%E6%BA%96%E5%82%99%E3%81%99%E3%82%8B">#</a></h2>
<p>本家では <code>public static final Parcelable.Creator&lt;MyParcelable&gt; CREATOR = …</code> な感じで用意していましたが、Xamarin.Android では次の２点が異なります。</p>
<ol>
<li>匿名クラスが使えないので、<code>IParcelableCreator</code> インターフェースを実装したクラスを用意する。</li>
<li>CREATOR フィールドの代わりに <code>IParcelableCreator</code> を返す static メソッドを用意し、<code>[ExportField(&quot;CREATOR&quot;)]</code> 属性を付ける。</li>
</ol>
<p>これらを実装すると、 Card クラスはこうなります。</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">Java<span class="token punctuation">.</span>Interop</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token namespace">HelloXamarinAndroid</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">class</span> <span class="token class-name">Card</span>  <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Java<span class="token punctuation">.</span>Lang<span class="token punctuation">.</span>Object</span><span class="token punctuation">,</span> <span class="token class-name">IParcelable</span></span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Phone <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><br><br>        <span class="token keyword">public</span> <span class="token function">Card</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> phone<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> name<span class="token punctuation">;</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>Phone <span class="token operator">=</span> phone<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token preprocessor property">#<span class="token directive keyword">region</span> IParcelable implementation</span><br><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">DescribeContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteToParcel</span><span class="token punctuation">(</span><span class="token class-name">Parcel</span> dest<span class="token punctuation">,</span> <span class="token class-name">ParcelableWriteFlags</span> flags<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            dest<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            dest<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Phone<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span><br><br>        <span class="token punctuation">[</span><span class="token function">ExportField</span><span class="token punctuation">(</span><span class="token string">"CREATOR"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IParcelableCreator</span> <span class="token function">GetCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyParcelableCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Parcelable.Creator の代わり</span><br>        <span class="token keyword">class</span> <span class="token class-name">MyParcelableCreator</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Java<span class="token punctuation">.</span>Lang<span class="token punctuation">.</span>Object</span><span class="token punctuation">,</span> <span class="token class-name">IParcelableCreator</span></span><br>        <span class="token punctuation">{</span><br>            <span class="token preprocessor property">#<span class="token directive keyword">region</span> IParcelableCreator implementation</span><br>            <span class="token return-type class-name">Java<span class="token punctuation">.</span>Lang<span class="token punctuation">.</span>Object</span> IParcelableCreator<span class="token punctuation">.</span><span class="token function">CreateFromParcel</span><span class="token punctuation">(</span><span class="token class-name">Parcel</span> source<span class="token punctuation">)</span><br>            <span class="token punctuation">{</span><br>                <span class="token class-name"><span class="token keyword">var</span></span> name <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token class-name"><span class="token keyword">var</span></span> phone <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Card</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token return-type class-name">Java<span class="token punctuation">.</span>Lang<span class="token punctuation">.</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span></span> IParcelableCreator<span class="token punctuation">.</span><span class="token function">NewArray</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> size<span class="token punctuation">)</span><br>            <span class="token punctuation">{</span><br>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Java<span class="token punctuation">.</span>Lang<span class="token punctuation">.</span>Object</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>これでやっと、「受け渡し可能な」クラスが作成できました。</p>
<h2 id="%E5%8F%97%E3%81%91%E6%B8%A1%E3%81%97%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">受け渡ししてみる <a class="direct-link" href="#%E5%8F%97%E3%81%91%E6%B8%A1%E3%81%97%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">#</a></h2>
<p>まず渡す方。Intent に詰めます。</p>
<pre class="language-csharp"><code class="language-csharp">button<span class="token punctuation">.</span>Click <span class="token operator">+=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=></span> <br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> card <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Card</span><span class="token punctuation">(</span><span class="token string">"amay"</span><span class="token punctuation">,</span> <span class="token string">"987-654-3321"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Goto NextActivity</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">NextActivity</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    intent<span class="token punctuation">.</span><span class="token function">PutExtra</span><span class="token punctuation">(</span><span class="token string">"card"</span><span class="token punctuation">,</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// intent に Card を詰める</span><br><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">StartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>次に取り出す方。Intent から取り出します。</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> <span class="token namespace">HelloXamarinAndroid</span><br><span class="token punctuation">{</span><br>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Activity</span> <span class="token attribute-arguments"><span class="token punctuation">(</span>Label <span class="token operator">=</span> <span class="token string">"NextActivity"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NextActivity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Activity</span></span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> bundle<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnCreate</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token comment">// Create your application here</span><br><br>            <span class="token class-name"><span class="token keyword">var</span></span> card <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Intent<span class="token punctuation">.</span><span class="token function">GetParcelableExtra</span><span class="token punctuation">(</span><span class="token string">"card"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">Card</span><span class="token punctuation">;</span><br><br>            <span class="token comment">// Show toast</span><br>            Toast<span class="token punctuation">.</span><span class="token function">MakeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <br>                String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"name:{0}, phone:{1}"</span><span class="token punctuation">,</span> card<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> card<span class="token punctuation">.</span>Phone<span class="token punctuation">)</span><span class="token punctuation">,</span> <br>                ToastLength<span class="token punctuation">.</span>Long<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><code>〜 as Type</code> 句は型が違っていたら null にしてくれる書き方です。<br>
あと Toast。<code>.Show()</code> は忘れずに。</p>
<p>これで実装完了。動かしてみます。</p>
<p><img src="https://blog.amay0777.net/img/posts/xamarin_parcel_received.png" alt="&quot;receive_parcel&quot;"></p>
<p>以上、受け渡し可能なクラスの実装方法でした。</p>
<h2 id="%E3%81%BE%E3%81%A8%E3%82%81">まとめ <a class="direct-link" href="#%E3%81%BE%E3%81%A8%E3%82%81">#</a></h2>
<ul>
<li>Mono.Android.Export の追加を忘れない</li>
<li>CREATOR フィールドの代わりに [ExportField(&quot;CREATOR&quot;)] 属性を付ける</li>
<li>Java の匿名クラスは意外と便利だった</li>
<li>せっかくプロジェクト作ったので GitHub に置いておきます - <a href="https://github.com/amay077/XamarinAndroid_ParcelableSample/tree/Posted_Qiita">amay077 / XamarinAndroid_ParcelableSample</a></li>
</ul>
<h2 id="%E5%8F%82%E8%80%83">参考 <a class="direct-link" href="#%E5%8F%82%E8%80%83">#</a></h2>
<ul>
<li><a href="http://dan.clarke.name/2012/09/implementing-iparcelable-in-mono-for-android/">Implementing IParcelable in Mono for Android » Dan Clarke</a></li>
<li><a href="https://github.com/xamarin/monodroid-samples/tree/master/ExportAttribute">monodroid-samples/ExportAttribute at master · xamarin/monodroid-samples</a> なんだ、本家のサンプルあるじゃん</li>
<li><a href="http://docs.xamarin.com/guides/android/advanced_topics/limitations">Limitations ｜ xamarin</a> 制限だったり、制限が解除された情報が載ってるので要チェック</li>
</ul>


published at <time class="postlist-date" datetime="2013-03-01">01 Mar 2013</time>

tags: 

  <a href="/tags/Xamarin/" class="post-tag">Xamarin</a>
  <a href="/tags/Android/" class="post-tag">Android</a>
  <a href="/tags/Csharp/" class="post-tag">Csharp</a>

<hr>
<ul><li>Next: <a href="/blog/2013/03/02/xamarin-android-permission/">Xamarin.Android で PERMISSION を設定する</a></li><li>Previous: <a href="/blog/2013/03/01/how-to-use-rx-in-xamarin/">Xamarin.Android で Reactive Extensions を使う</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2013/03/01/xamarin-android-implement-parcelable/ -->
  </body>
</html>
