<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xamarin.Android でアプリの言語を動的に切り替える</title>
    <meta name="description" content="Try and try again">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Experiments Never Fail">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Experiments Never Fail">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-224332-7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-224332-7');
    </script>
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Experiments Never Fail</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <!-- Delete this message 
      <div class="warning">
        <ol>
          <li>Edit the <code>_data/metadata.json</code> with your blog’s information.</li>
          <li>(Optional) Edit <code>.eleventy.js</code> with your <a href="https://www.11ty.dev/docs/config/">configuration preferences</a>.</li>
          <li>Delete this message from <code>_includes/layouts/base.njk</code>.</li>
        </ol>
        <p><em>This is an <a href="https://www.11ty.dev/">Eleventy project</a> created from the <a href="https://github.com/11ty/eleventy-base-blog"><code>eleventy-base-blog</code> repo</a>.</em></p>
      </div>
      Stop deleting -->

      <h1>Xamarin.Android でアプリの言語を動的に切り替える</h1>

<p>複数言語のリソースを用意しておいて、システムの言語を変えると、アプリで使用される言語リソースも変わるわけですが、システム設定に関係なく、アプリ内で言語選択をしたい。</p>
<!--more-->
<p>つまり、</p>
<ul>
<li><a href="https://stackoverflow.com/questions/39705739/android-n-change-language-programmatically/40849142#40849142">java - Android N change language programmatically - Stack Overflow</a></li>
</ul>
<p>これ。<br>
Kotlin でもできたので、どうせならということで Xamarin.Android でもやってみました。</p>
<h2 id="%E3%81%A7%E3%81%8D%E3%81%82%E3%81%8C%E3%82%8A">できあがり <a class="direct-link" href="#%E3%81%A7%E3%81%8D%E3%81%82%E3%81%8C%E3%82%8A">#</a></h2>
<p>こんな感じの成果になります。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/9a6e1a7b-0acd-85a6-eb2f-7f63dfc0a1b2.gif" alt="Untitled.gif"></p>
<h2 id="%E6%96%B9%E6%B3%95">方法 <a class="direct-link" href="#%E6%96%B9%E6%B3%95">#</a></h2>
<h3 id="1.-%E5%A4%9A%E8%A8%80%E8%AA%9E%E7%94%A8%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B">1. 多言語用のリソースファイルを用意する <a class="direct-link" href="#1.-%E5%A4%9A%E8%A8%80%E8%AA%9E%E7%94%A8%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B">#</a></h3>
<p>Android の仕様に従って <code>values/</code> や <code>values-ja-rJP/</code> に <code>String.xml</code> を用意します。<br>
ファイルを追加した後で、Build Action が「AndroidResource」になっている事を確認してください。</p>
<p><strong>values/String.xml (英語ってかデフォルト):</strong></p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ResourceTest<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>welcome<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>WELCOME<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>to_japanese<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>To Japanese<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>to_english<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>To English<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">></span></span></code></pre>
<p><strong>values-ja-rJP/String.xml (日本語):</strong></p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ResourceTest<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>welcome<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ようこそ<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>to_japanese<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>日本語にする<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>string</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>to_english<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>英語にする<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>string</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">></span></span></code></pre>
<h2 id="2.-mainactivity-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B">2. MainActivity を実装する <a class="direct-link" href="#2.-mainactivity-%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B">#</a></h2>
<p>とりあえずざっと。</p>
<p><strong>MainActivity.cs:</strong></p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>App</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>Widget</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>OS</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>Content</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>Content<span class="token punctuation">.</span>Res</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Java<span class="token punctuation">.</span>Util</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token namespace">ResourceTest</span><br><span class="token punctuation">{</span><br>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Activity</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Label <span class="token operator">=</span> <span class="token string">"ResourceTest"</span><span class="token punctuation">,</span> MainLauncher <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Icon <span class="token operator">=</span> <span class="token string">"@mipmap/icon"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Activity</span></span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AttachBaseContext</span><span class="token punctuation">(</span><span class="token class-name">Context</span> baseContext<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token class-name"><span class="token keyword">var</span></span> pref <span class="token operator">=</span> baseContext<span class="token punctuation">.</span><span class="token function">GetSharedPreferences</span><span class="token punctuation">(</span><span class="token string">"mypref"</span><span class="token punctuation">,</span> FileCreationMode<span class="token punctuation">.</span>Private<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token class-name"><span class="token keyword">var</span></span> locale <span class="token operator">=</span> pref<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"locale"</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token class-name"><span class="token keyword">var</span></span> newLocale <span class="token operator">=</span> Locale<span class="token punctuation">.</span><span class="token function">GetAvailableLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><br>                l <span class="token operator">=></span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> locale<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span><br>                                  <span class="token operator">??</span> Locale<span class="token punctuation">.</span>Default<span class="token punctuation">;</span><br><br>            <span class="token class-name"><span class="token keyword">var</span></span> configuration <span class="token operator">=</span> baseContext<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span><br>            configuration<span class="token punctuation">.</span>Locale <span class="token operator">=</span> newLocale<span class="token punctuation">;</span><br>            <span class="token class-name"><span class="token keyword">var</span></span> newContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ContextWrapper</span><span class="token punctuation">(</span><br>                baseContext<span class="token punctuation">.</span><span class="token function">CreateConfigurationContext</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><br>            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">AttachBaseContext</span><span class="token punctuation">(</span>newContext<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token function">SetContentView</span><span class="token punctuation">(</span>Resource<span class="token punctuation">.</span>Layout<span class="token punctuation">.</span>Main<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token generic-method"><span class="token function">FindViewById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TextView<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>Resource<span class="token punctuation">.</span>Id<span class="token punctuation">.</span>textWelcome<span class="token punctuation">)</span><span class="token punctuation">.</span>Text <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>Resource<span class="token punctuation">.</span>String<span class="token punctuation">.</span>welcome<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token class-name"><span class="token keyword">var</span></span> pref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetSharedPreferences</span><span class="token punctuation">(</span><span class="token string">"mypref"</span><span class="token punctuation">,</span> FileCreationMode<span class="token punctuation">.</span>Private<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token generic-method"><span class="token function">FindViewById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Button<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>Resource<span class="token punctuation">.</span>Id<span class="token punctuation">.</span>buttonToEnglish<span class="token punctuation">)</span><span class="token punctuation">.</span>Click <span class="token operator">+=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=></span> <br>            <span class="token punctuation">{</span><br>                <span class="token class-name"><span class="token keyword">var</span></span> editor <span class="token operator">=</span> pref<span class="token punctuation">.</span><span class="token function">Edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                editor<span class="token punctuation">.</span><span class="token function">PutString</span><span class="token punctuation">(</span><span class="token string">"locale"</span><span class="token punctuation">,</span> <span class="token string">"en_US"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                editor<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token function">Restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>            <span class="token generic-method"><span class="token function">FindViewById</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Button<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>Resource<span class="token punctuation">.</span>Id<span class="token punctuation">.</span>buttonToJapanese<span class="token punctuation">)</span><span class="token punctuation">.</span>Click <span class="token operator">+=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=></span><br>            <span class="token punctuation">{</span><br>                <span class="token class-name"><span class="token keyword">var</span></span> editor <span class="token operator">=</span> pref<span class="token punctuation">.</span><span class="token function">Edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                editor<span class="token punctuation">.</span><span class="token function">PutString</span><span class="token punctuation">(</span><span class="token string">"locale"</span><span class="token punctuation">,</span> <span class="token string">"ja_JP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                editor<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token function">Restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token class-name"><span class="token keyword">var</span></span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">MainActivity</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">StartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>簡単に説明すると 「<code>AttachBaseContext()</code> を override して、そこで任意の Locale に変えた <code>Context</code> にすげ替え」ています。</p>
<p>「任意の Locale」は、2つのボタンを押したときにそれぞれ <code>ja_JP</code>、<code>en_US</code> を SharedPreference に保存しておき、Activity を再起動します。</p>
<p>再起動直後に <code>AttachBaseContext()</code> が呼ばれるので、そこで SharedPreference に記憶された Locale を読み出しています。</p>
<h2 id="%E3%81%8A%E3%81%BE%E3%81%91">おまけ <a class="direct-link" href="#%E3%81%8A%E3%81%BE%E3%81%91">#</a></h2>
<p>1st try では、SharedPref を使うのを面倒くさがって、<code>Application</code> クラスに記憶させとく作戦でしたが、失敗しました。その原因は <code>AttachBaseContext()</code> は <code>OnCreate()</code> よりも先に呼ばれ、さらに <code>AttachBaseContext()</code> の時点では <code>Activity.Application</code> が <code>null</code> になっているためでした。</p>


published at <time class="postlist-date" datetime="2018-05-21">21 May 2018</time>

tags: 

  <a href="/tags/Android/" class="post-tag">Android</a>
  <a href="/tags/Csharp/" class="post-tag">Csharp</a>
  <a href="/tags/Xamarin/" class="post-tag">Xamarin</a>

<hr>
<ul><li>Next: <a href="/blog/2018/05/24/d4629f9d20ba36a1347e/">MV* の「つなぎ」に RxJava を使うのをやめたい</a></li><li>Previous: <a href="/blog/2018/05/07/333a5bbf4e5fa52512fb/">新しい Google Maps Platform では APIキーなしの呼び出しはサポートされなくなります</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2018/05/21/02e4e7c082014d22d08a/ -->
  </body>
</html>
