<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xamarin.Forms の WebView で JavaScript 連携を行う(with iOS/Android共通化)</title>
    <meta name="description" content="Try and try again">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Experiments Never Fail">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Experiments Never Fail">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-224332-7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-224332-7');
    </script>
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Experiments Never Fail</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <!-- Delete this message 
      <div class="warning">
        <ol>
          <li>Edit the <code>_data/metadata.json</code> with your blog’s information.</li>
          <li>(Optional) Edit <code>.eleventy.js</code> with your <a href="https://www.11ty.dev/docs/config/">configuration preferences</a>.</li>
          <li>Delete this message from <code>_includes/layouts/base.njk</code>.</li>
        </ol>
        <p><em>This is an <a href="https://www.11ty.dev/">Eleventy project</a> created from the <a href="https://github.com/11ty/eleventy-base-blog"><code>eleventy-base-blog</code> repo</a>.</em></p>
      </div>
      Stop deleting -->

      <h1>Xamarin.Forms の WebView で JavaScript 連携を行う(with iOS/Android共通化)</h1>

<h2 id="%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E4%BA%8B">やりたい事 <a class="direct-link" href="#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E4%BA%8B">#</a></h2>
<!--more-->
<p>Xamarin.Forms 製アプリの WebView に表示した Webページから、ネイティブ(C#)で時間のかかる処理を行い、結果を JavaScript に通知したい。<br>
JavaScript のコードは Android/iOS で共通にしたい。</p>
<p>具体的には、次のような JavaScript コードの <code>heavyAdd(num)</code> を実行した時に、ネイティブ側で処理を行い、結果を <code>onResult(res)</code> で受信したい。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">addAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <br>  MyCalc<span class="token punctuation">.</span><span class="token function-variable function">onResult</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> label <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    label<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'MyCalc.onResult - '</span> <span class="token operator">+</span> res<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  MyCalc<span class="token punctuation">.</span><span class="token function">heavyAdd</span><span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="%E3%81%A7%E3%81%8D%E3%81%9F%EF%BC%81">できた！ <a class="direct-link" href="#%E3%81%A7%E3%81%8D%E3%81%9F%EF%BC%81">#</a></h2>
<ul>
<li>前提 - Xamarin.Forms 3.4.x が必要</li>
</ul>
<h3 id="%E5%85%B1%E9%80%9A">共通 <a class="direct-link" href="#%E5%85%B1%E9%80%9A">#</a></h3>
<p><strong>sample.html</strong></p>
<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ja<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>    <span class="token keyword">function</span> <span class="token function">addAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <br>      MyCalc<span class="token punctuation">.</span><span class="token function-variable function">onResult</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">var</span> label <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        label<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'MyCalc.onResult - '</span> <span class="token operator">+</span> res<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>      MyCalc<span class="token punctuation">.</span><span class="token function">heavyAdd</span><span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>WebView−JavaScript連携サンプル<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>addAsync();<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>計算実行<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p>ローカルPC にある <code>sample.html</code> は、 Webサーバー(<a href="http://rennnosukesann.hatenablog.com/entry/2018/03/19/233245">npm serve とか</a>)を立てて、 <a href="https://qiita.com/mininobu/items/b45dbc70faedf30f484e">ngrok</a> を使って外部公開するのが便利ですね。</p>
<p><strong>MainPage.xaml</strong></p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ContentPage</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xamarin.com/schemas/2014/forms<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2009/xaml<span class="token punctuation">"</span></span> <br>    <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:WebViewSample<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>WebViewSample.MainPage<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackLayout</span> <span class="token attr-name">Orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Vertical<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>WebView</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webView<span class="token punctuation">"</span></span> <br>                 <span class="token attr-name">Source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://xxxx.ngrok.io/sample.html<span class="token punctuation">"</span></span><br>                 <span class="token attr-name">VerticalOptions</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>FillAndExpand<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackLayout</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ContentPage</span><span class="token punctuation">></span></span></code></pre>
<h3 id="android%E5%81%B4">Android側 <a class="direct-link" href="#android%E5%81%B4">#</a></h3>
<p><strong>Android の CustomWebViewRenderer.cs</strong></p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Android<span class="token punctuation">.</span>Content</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Java<span class="token punctuation">.</span>Interop</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Xamarin<span class="token punctuation">.</span>Forms</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Xamarin<span class="token punctuation">.</span>Forms<span class="token punctuation">.</span>Platform<span class="token punctuation">.</span>Android</span><span class="token punctuation">;</span><br><br><span class="token punctuation">[</span><span class="token attribute"><span class="token target keyword">assembly</span><span class="token punctuation">:</span> <span class="token class-name">ExportRenderer</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">WebView</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">WebViewSample<span class="token punctuation">.</span>Droid<span class="token punctuation">.</span>CustomWebViewRenderer</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><br><br><span class="token keyword">namespace</span> <span class="token namespace">WebViewSample<span class="token punctuation">.</span>Droid</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomWebViewRenderer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Xamarin<span class="token punctuation">.</span>Forms<span class="token punctuation">.</span>Platform<span class="token punctuation">.</span>Android<span class="token punctuation">.</span>WebViewRenderer</span></span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">public</span> <span class="token function">CustomWebViewRenderer</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><br><br>        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnElementChanged</span><span class="token punctuation">(</span><span class="token class-name">ElementChangedEventArgs<span class="token punctuation">&lt;</span>WebView<span class="token punctuation">></span></span> e<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnElementChanged</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            Control<span class="token punctuation">.</span><span class="token function">AddJavascriptInterface</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">JavaScriptHandler</span><span class="token punctuation">(</span>Control<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MyCalc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">class</span> <span class="token class-name">JavaScriptHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Java<span class="token punctuation">.</span>Lang<span class="token punctuation">.</span>Object</span></span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Android<span class="token punctuation">.</span>Webkit<span class="token punctuation">.</span>WebView</span> webView<span class="token punctuation">;</span><br><br>        <span class="token keyword">public</span> <span class="token function">JavaScriptHandler</span><span class="token punctuation">(</span><span class="token class-name">Android<span class="token punctuation">.</span>Webkit<span class="token punctuation">.</span>WebView</span> webView<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>webView <span class="token operator">=</span> webView<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Export</span></span><span class="token punctuation">]</span><br>        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Android<span class="token punctuation">.</span>Webkit<span class="token punctuation">.</span>JavascriptInterface</span></span><span class="token punctuation">]</span><br>        <span class="token keyword">async</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">heavyAdd</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> num<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> num <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span><br><br>            <span class="token comment">// メインスレッドから呼ばないとエラー</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>webView<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <br>            <span class="token punctuation">{</span><br>                <span class="token keyword">this</span><span class="token punctuation">.</span>webView<span class="token punctuation">.</span><span class="token function">LoadUrl</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"javascript:MyCalc.onResult(</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">result</span><span class="token punctuation">}</span></span><span class="token string">);"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<ul>
<li><a href="https://qiita.com/usayuki/items/aebd4e3ab791b7b008ca">[Android][Kotlin]JavaScriptと相互通信 - Qiita</a></li>
</ul>
<p>を参考に、ネイティブのやり方をカスタムレンダラーで。<br>
Android の方はまだ単純で <code>AddJavascriptInterface()</code> の第2引数がクラス名に、<code>JavascriptInterface</code> 属性を付けたメソッドが JavaScript のメソッド名になる。<br>
結果の通知は <code>this.webView.LoadUrl($&quot;javascript:MyCalc.onResult(xx);</code> で。</p>
<h3 id="ios%E5%81%B4">iOS側 <a class="direct-link" href="#ios%E5%81%B4">#</a></h3>
<p><strong>iOS の CustomWebViewRenderer.cs</strong></p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Foundation</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">WebKit</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Xamarin<span class="token punctuation">.</span>Forms</span><span class="token punctuation">;</span><br><span class="token keyword">using</span> <span class="token namespace">Xamarin<span class="token punctuation">.</span>Forms<span class="token punctuation">.</span>Platform<span class="token punctuation">.</span>iOS</span><span class="token punctuation">;</span><br><br><span class="token punctuation">[</span><span class="token attribute"><span class="token target keyword">assembly</span><span class="token punctuation">:</span> <span class="token class-name">ExportRenderer</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">WebView</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">WebViewSample<span class="token punctuation">.</span>iOS<span class="token punctuation">.</span>CustomWebViewRenderer</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><br><br><span class="token keyword">namespace</span> <span class="token namespace">WebViewSample<span class="token punctuation">.</span>iOS</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomWebViewRenderer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Xamarin<span class="token punctuation">.</span>Forms<span class="token punctuation">.</span>Platform<span class="token punctuation">.</span>iOS<span class="token punctuation">.</span>WkWebViewRenderer</span><span class="token punctuation">,</span> <span class="token class-name">IWKScriptMessageHandler</span></span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnElementChanged</span><span class="token punctuation">(</span><span class="token class-name">VisualElementChangedEventArgs</span> e<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnElementChanged</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token class-name"><span class="token keyword">var</span></span> webView <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>NativeView <span class="token keyword">as</span> <span class="token class-name">WKWebView</span><span class="token punctuation">;</span><br><br>            <span class="token comment">// JavaScript から呼び出すハンドラを追加。</span><br>            webView<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>UserContentController<span class="token punctuation">.</span><span class="token function">AddScriptMessageHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"MyHeavyAdd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token comment">// JavaScript 側で MyCalc.heavyAdd(n) が呼ばれた時に window.webkit.messageHandlers.xxx を呼ぶようにする。</span><br>            <span class="token class-name"><span class="token keyword">var</span></span> script <span class="token operator">=</span><br>                <span class="token string">"MyCalc = {};"</span> <span class="token operator">+</span><br>                <span class="token string">"MyCalc.heavyAdd = function (num) { window.webkit.messageHandlers.MyHeavyAdd.postMessage(num); };"</span><span class="token punctuation">;</span><br>            webView<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>UserContentController<span class="token punctuation">.</span><span class="token function">AddUserScript</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">WKUserScript</span><span class="token punctuation">(</span><br>                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NSString</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">,</span> WKUserScriptInjectionTime<span class="token punctuation">.</span>AtDocumentStart<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> IWKScriptMessageHandler<span class="token punctuation">.</span><span class="token function">DidReceiveScriptMessage</span><span class="token punctuation">(</span><span class="token class-name">WKUserContentController</span> userContentController<span class="token punctuation">,</span> <span class="token class-name">WKScriptMessage</span> message<span class="token punctuation">)</span><br>        <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">"MyHeavyAdd"</span><span class="token punctuation">)</span> <br>            <span class="token punctuation">{</span><br>                <span class="token comment">// 時間のかかる処理</span><br>                <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Body <span class="token keyword">as</span> <span class="token class-name">NSNumber</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Int32Value <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span><br><br>                <span class="token comment">// 結果を通知</span><br>                <span class="token class-name"><span class="token keyword">var</span></span> webView <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>NativeView <span class="token keyword">as</span> <span class="token class-name">WKWebView</span><span class="token punctuation">;</span><br>                webView<span class="token punctuation">.</span><span class="token function">EvaluateJavaScript</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"MyCalc.onResult(</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">result</span><span class="token punctuation">}</span></span><span class="token string">);"</span></span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<ul>
<li><a href="https://qiita.com/usayuki/items/6979d0d6f7d8f5b302ad">[iOS][Swift]JavaScriptと相互通信 - Qiita</a></li>
</ul>
<p>を参考にカスタムレンダラーで実装。</p>
<p>ポイント1。Xamarin.Forms 3.4から? WebView の実装が <code>WKWebView</code> になった模様。それまでは(少なくとも Xamarin.Forms 3.1 では) UIWebView だった。<br>
Xamarin.Forms 3.4 でないと <a href="https://github.com/xamarin/Xamarin.Forms/blob/3.4.0/Xamarin.Forms.Platform.iOS/Renderers/WkWebViewRenderer.cs"><code>Xamarin.Forms.Platform.iOS.WkWebViewRenderer</code></a> が存在しないため使えない。</p>
<p>ポイント２。iOS で JavaScript からネイティブの処理を呼ぶには <code>window.webkit.messageHandlers.xxxx.postMessage()</code> を使わなければならないが、これでは Android 側と共通化できないので、<code>AddUserScript</code> で <code>window.webkit.〜</code> を <code>MyCalc.heavyAdd</code> にマップしている。</p>
<p>ポイント３。JavaScript からの呼び出しに反応するのは <code>IWKScriptMessageHandler</code> インターフェース。</p>
<h2 id="%E3%81%93%E3%82%93%E3%81%AA%E6%84%9F%E3%81%98">こんな感じ <a class="direct-link" href="#%E3%81%93%E3%82%93%E3%81%AA%E6%84%9F%E3%81%98">#</a></h2>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/488b5e50-3059-0897-0ea8-9d51b9592957.png" alt="image.png"></p>
<p>端的に言うと、Android と異なる iOS の JavaScript→ネイティブ呼び出しを、AddUserScript で同じAPIにラップしたよーというお話でした。</p>


published at <time class="postlist-date" datetime="2018-12-18">18 Dec 2018</time>

tags: 

  <a href="/tags/Xamarin/" class="post-tag">Xamarin</a>
  <a href="/tags/Android/" class="post-tag">Android</a>
  <a href="/tags/iOS/" class="post-tag">iOS</a>
  <a href="/tags/Csharp/" class="post-tag">C#</a>
  <a href="/tags/JavaScript/" class="post-tag">JavaScript</a>

<hr>
<ul><li>Next: <a href="/blog/2018/12/25/150f484e68924468a2c3/">Xamarin.Forms でも HotReload がしたい！</a></li><li>Previous: <a href="/blog/2018/12/14/4c418310872e8659fe6a/">Azure Custom Vision に投入する学習用画像データを imgaug を使って水増ししてみた</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2018/12/18/2a8f14684b1210d75c1e/ -->
  </body>
</html>
