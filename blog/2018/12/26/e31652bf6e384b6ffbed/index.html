<hr />
<p>layout: post<br />
title: “Azure Pipelines の Android アプリビルドでビルドタイプを指定する”<br />
date: 2018/12/26 23:59:00 +0900<br />
comments: true<br />
categories: [Azure, AzureDevOps, Android]<br />
—。<br />
<a href="https://azure.microsoft.com/ja-jp/services/devops/pipelines/">Azure Pipelines</a> で Android アプリ(Not Xamarin)をビルドする時、普通にテンプレから作った gradle タスクは、 <code class="highlighter-rouge">gradlew build</code> を実行しますが、これはアプリのプロジェクトに含まれる全てのビルドタイプをビルドするため、多くの場合ムダです。<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup><br />
<!--more--></p>

<p>例えば私のプロジェクトの場合、ビルドタイプは標準の「Debug」,「Release」に加え実験用の「Experiment」を用意していたので、タスクの実行に 12分 もかかっていました。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/346f0a15-a0c9-f671-9046-d90d3e39ce5a.png" alt="image.png" /></p>

<p>完了後、Debug, Release, Experiment それぞれの <code class="highlighter-rouge">.apk</code> が生成されていました。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/5390eac9-9deb-42b1-8155-a3e0659f25cf.png" alt="image.png" /></p>

<h2 id="release-のみをビルドする">Release のみをビルドする</h2>

<p>特定のビルドタイプのみ（ここでは Release とします）をビルドする場合、<code class="highlighter-rouge">gradlew build</code> の代わりに <code class="highlighter-rouge">gradlew assembleRelease</code> を実行すればよいのですが、既定で追加されている gradle タスクではなぜか変更できません。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/91a0b402-1cdc-2628-dfde-67c25b693a65.png" alt="image.png" /></p>

<p>仕方がないので、既存の gradle タスクは削除して、「＋」 で gradle タスクを検索して追加します。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/70053a12-60e8-d632-03af-6bac2faf4d66.png" alt="image.png" /></p>

<p>こちらの Tasks は変更できるので <code class="highlighter-rouge">assembleRelease</code> を設定します。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/13f771df-de9e-f480-21ec-1f8926722de3.png" alt="image.png" /></p>

<p>これで保存してパイプラインを実行すると、ビルドタスクの時間が 12分 から <strong>8分</strong> に短縮されました。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/c59dc0e7-8e5f-6cb6-387a-6872f4de6610.png" alt="image.png" /></p>

<p>Artifacts にも Release 版の apk しか生成されていないのが確認できます。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/cbc5cf63-50cf-6eea-88a2-0d0c3f22ecac.png" alt="image.png" /></p>

<p><a href="https://twitter.com/penguin_sharp/status/1077762715853107201">@penguin_sharp さん</a>、ありがとうございました。</p>

<h2 id="おまけ">おまけ</h2>

<p>上記はビルドAgent 「Hosted VS2017」 で作業してたんですが、これを 「Hosted macOS」 に替えたところ、 8分かかっていたビルド時間が <strong>「2分50秒」</strong> に短縮されました。</p>

<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/05a69245-4fe5-ab16-53de-24fdca7cca13.png" alt="image.png" /></p>

<p>VS2017 が遅いのか Hosted macOS が早いのか分かりませんが、とりあえず Android アプリのビルドは Hosted macOS を使うとよさそうです。<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup></p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Debug ビルドで単体テストを行い、同時に配布用 Release ビルドを生成したい、というケースでもあるのでしょうか？わからん。 <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>Xamarin.Android も Hosted macOS でビルドしたいなー、確か Xamarin.iOS しかビルドできないんだよなー <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>
