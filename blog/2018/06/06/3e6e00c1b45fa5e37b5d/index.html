<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase を最新の環境で使用する【2018年6月版】</title>
    <meta name="description" content="Try and try again">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Experiments Never Fail">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Experiments Never Fail">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-224332-7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-224332-7');
    </script>
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Experiments Never Fail</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <!-- Delete this message 
      <div class="warning">
        <ol>
          <li>Edit the <code>_data/metadata.json</code> with your blog’s information.</li>
          <li>(Optional) Edit <code>.eleventy.js</code> with your <a href="https://www.11ty.dev/docs/config/">configuration preferences</a>.</li>
          <li>Delete this message from <code>_includes/layouts/base.njk</code>.</li>
        </ol>
        <p><em>This is an <a href="https://www.11ty.dev/">Eleventy project</a> created from the <a href="https://github.com/11ty/eleventy-base-blog"><code>eleventy-base-blog</code> repo</a>.</em></p>
      </div>
      Stop deleting -->

      <h1>Firebase を最新の環境で使用する【2018年6月版】</h1>

<p>Firebase Cloud Messaging を最新の開発環境で使おうとしたらいろいろハマったので手順をまとめてみました。</p>
<!--more-->
<p>だらだら長くなったので短くまとめると、</p>
<ul>
<li><code>com.google.firebase:firebase-messaging:17.0.0</code> と <code>apply plugin: 'com.google.gms.google-services'</code> が仲が悪い</li>
<li>ので <code>apply plugin: 'com.google.gms.google-services'</code> を使わないようにした</li>
<li>それに伴い <code>google-services.json</code> も使わないようにした</li>
<li>Firebase のプロジェクト設定は環境変数から埋め込むようにした</li>
</ul>
<p>です。</p>
<h2 id="1.-%E3%81%A8%E3%82%8A%E3%81%82%E3%81%88%E3%81%9A-android-studio-%E3%81%A7%E6%96%B0%E8%A6%8F%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B">1. とりあえず Android Studio で新規プロジェクトを作る <a class="direct-link" href="#1.-%E3%81%A8%E3%82%8A%E3%81%82%E3%81%88%E3%81%9A-android-studio-%E3%81%A7%E6%96%B0%E8%A6%8F%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B">#</a></h2>
<ul>
<li>
<p>Android Studio のバージョンは 3.1.2</p>
</li>
<li>
<p>:heavy_check_mark: Include Kotlin support</p>
</li>
<li>
<p>Targeting API 23 and later</p>
</li>
<li>
<p>:heavy_check_mark: Backward Compatibility(AppCompat)</p>
</li>
</ul>
<p><strong>プロジェクト削除直後の <code>app/build.gradle</code>:</strong></p>
<pre><code>apply plugin: 'com.android.application'

apply plugin: 'kotlin-android'

apply plugin: 'kotlin-android-extensions'

android {
    compileSdkVersion 27
    defaultConfig {
        applicationId &quot;net.yourdomain.fcmsample&quot;
        minSdkVersion 23
        targetSdkVersion 27
        versionCode 1
        versionName &quot;1.0&quot;
        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation&quot;org.jetbrains.kotlin:kotlin-stdlib-jre7:$kotlin_version&quot;
    implementation 'com.android.support:appcompat-v7:27.1.1'
    implementation 'com.android.support.constraint:constraint-layout:1.1.0'
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'com.android.support.test:runner:1.0.2'
    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'
}
</code></pre>
<h2 id="2.-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB-firebase-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">2. プロジェクトに Firebase を追加する <a class="direct-link" href="#2.-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB-firebase-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">#</a></h2>
<ul>
<li><a href="https://firebase.google.com/docs/android/setup?hl=ja">Android プロジェクトに Firebase を追加する  |  Firebase</a></li>
</ul>
<p>の手順をトレース。Firebase Cloud Messaging(FCM) が使いたかったので &quot;Cloud Messaging&quot; から開始。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/0a783607-0793-764b-9bed-0c350b788a9c.png" alt="image.png"></p>
<p>「Connect to Firebase」と「Add FCM to your App」をやります。</p>
<p><strong>「Add FCM to your App」したあとの <code>app/build.gradle</code> :</strong></p>
<pre><code>apply plugin: 'com.android.application'

apply plugin: 'kotlin-android'

apply plugin: 'kotlin-android-extensions'

android {
    compileSdkVersion 27
    defaultConfig {
        applicationId &quot;net.yourdomain.fcmsample&quot;
        minSdkVersion 23
        targetSdkVersion 27
        versionCode 1
        versionName &quot;1.0&quot;
        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation &quot;org.jetbrains.kotlin:kotlin-stdlib-jre7:$kotlin_version&quot;
    implementation 'com.android.support:appcompat-v7:27.1.1'
    implementation 'com.android.support.constraint:constraint-layout:1.1.0'
    implementation 'com.google.firebase:firebase-messaging:11.8.0'
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'com.android.support.test:runner:1.0.2'
    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'
}

apply plugin: 'com.google.gms.google-services'
</code></pre>
<p><code>implementation 'com.google.firebase:firebase-messaging:11.8.0'</code> と <code>apply plugin: 'com.google.gms.google-services'</code> が追加された。<strong>後者は後で消します</strong>。</p>
<p>その他、ルートの <code>build.gradle</code> に <code>classpath 'com.google.gms:google-services:3.1.1'</code> が、<code>app</code> ディレクトリに <code>google-services.json</code> が追加される、 <strong>どちらも後で消します</strong>。 特に <code>google-services.json</code> は、プロジェクトIDやAPI Keyなどの秘匿情報が含まれるので git にコミットしない方がよいです。</p>
<p>gradle sync を行うと、なんか取り消し線が付いたり、赤線が付いたり、Warning が出たりするけど、synced successfully が出て成功はしました。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/ba6d8bae-48eb-1eea-62bc-6fb28cedf374.png" alt="image.png"></p>
<h2 id="3.-fcm-%E3%82%92%E3%81%A8%E3%82%8A%E3%81%82%E3%81%88%E3%81%9A%E4%BD%BF%E3%81%86%E3%81%A8%E3%81%93%E3%82%8D%E3%81%BE%E3%81%A7%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B">3. FCM をとりあえず使うところまで実装する <a class="direct-link" href="#3.-fcm-%E3%82%92%E3%81%A8%E3%82%8A%E3%81%82%E3%81%88%E3%81%9A%E4%BD%BF%E3%81%86%E3%81%A8%E3%81%93%E3%82%8D%E3%81%BE%E3%81%A7%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B">#</a></h2>
<ul>
<li><a href="https://firebase.google.com/docs/cloud-messaging/android/client?hl=ja">Android に Firebase Cloud Messaging クライアント アプリを設定する  |  Firebase</a></li>
</ul>
<p>に従い、必要なクラスを追加、 <code>AndroidManifest.xml</code> への設定を行います。</p>
<p><strong>AndroidManifest.xml</strong></p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span><br>          <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>net.yourdomain.fcmsample<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span><br>        <span class="token attr-name"><span class="token namespace">android:</span>allowBackup</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>roundIcon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@mipmap/ic_launcher_round<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>supportsRtl</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>        <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@style/AppTheme<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activity</span><span class="token punctuation">></span></span><br><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><br>            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.MyFirebaseMessagingService<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.google.firebase.MESSAGING_EVENT<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span><br><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span><br>            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.MyFirebaseInstanceIDService<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.google.firebase.INSTANCE_ID_EVENT<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span></code></pre>
<p><strong>MyFirebaseMessagingService.kt</strong></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">package</span> net<span class="token punctuation">.</span>yourdomain<span class="token punctuation">.</span>fcmsample<br><br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>FirebaseMessagingService<br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>RemoteMessage<br><br><span class="token keyword">class</span> MyFirebaseMessagingService <span class="token operator">:</span> <span class="token function">FirebaseMessagingService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onMessageReceived</span><span class="token punctuation">(</span>remoteMessage<span class="token operator">:</span> RemoteMessage<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// FCMメッセージを受信したときに呼び出される</span><br><br>        <span class="token comment">// 通知メッセージの受信</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>remoteMessage<span class="token operator">?</span><span class="token punctuation">.</span>notification <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">val</span> notification <span class="token operator">=</span> remoteMessage<span class="token punctuation">.</span>notification<br>            <span class="token keyword">val</span> title <span class="token operator">=</span> notification<span class="token operator">?</span><span class="token punctuation">.</span>title <span class="token operator">?:</span> <span class="token string">""</span><br>            <span class="token keyword">val</span> body <span class="token operator">=</span> notification<span class="token operator">?</span><span class="token punctuation">.</span>body <span class="token operator">?:</span> <span class="token string">""</span><br><br>            android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"FCM-TEST"</span><span class="token punctuation">,</span> <span class="token string">"メッセージタイプ: 通知\nタイトル: <span class="token interpolation variable">$title</span>\n本文: <span class="token interpolation variable">$body</span>"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><strong>MyFirebaseInstanceIDService.kt</strong></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">package</span> net<span class="token punctuation">.</span>yourdomain<span class="token punctuation">.</span>fcmsample<br><br><span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>iid<span class="token punctuation">.</span>FirebaseInstanceId<br><br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>iid<span class="token punctuation">.</span>FirebaseInstanceIdService<br><br><span class="token keyword">class</span> MyFirebaseInstanceIDService <span class="token operator">:</span> <span class="token function">FirebaseInstanceIdService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onTokenRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// トークンが更新されたときに呼び出される</span><br>        <span class="token keyword">val</span> refreshedToken <span class="token operator">=</span> FirebaseInstanceId<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>token <span class="token operator">?:</span> <span class="token string">""</span><br>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"FCM-TEST"</span><span class="token punctuation">,</span> <span class="token string">"Refreshed token: <span class="token interpolation variable">$refreshedToken</span>"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p><strong>MainActivity.kt</strong></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">package</span> net<span class="token punctuation">.</span>yourdomain<span class="token punctuation">.</span>fcmsample<br><br><span class="token keyword">import</span> android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatActivity<br><span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle<br><span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>iid<span class="token punctuation">.</span>FirebaseInstanceId<br><br><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><br>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><br><br>        <span class="token keyword">val</span> refreshedToken <span class="token operator">=</span> FirebaseInstanceId<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>token <span class="token operator">?:</span> <span class="token string">""</span><br>        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"FCM-TEST"</span><span class="token punctuation">,</span> <span class="token string">"Refreshed token: <span class="token interpolation variable">$refreshedToken</span>"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>ビルドして実行します。<br>
ここから先は実機が必要でしょうか。<br>
Play services 入りのエミュレータでは、<code>E/FirebaseInstanceId: Token retrieval failed: SERVICE_NOT_AVAILABLE</code> というエラーが出てしまいました(Google Maps API は使えるんですけど…)。</p>
<p>実機で動かすと、初回は <code>MyFirebaseInstanceIDService</code> 、次回以降は <code>MainActivity</code> で FCM のトークンが Logcat に出力されます。</p>
<pre><code>D/FCM-TEST: token = dRkrWdZqARg:APA91bFXU0-Z7OdL4UfyLmbRHhBq2w4OTMNncbFeIgJuqWt6EJVsRgNKUrdGGG3LZRjT9PLTGokKqb7_w4iRm1gl0Vydy77kHkkdKy0lZvNr1uNDXkaMKaiWX5n1YaxlvFtZDNYtO2Eq
</code></pre>
<p>な感じのやたら長い文字列です(ちなみに上の文字はフィクションです)。<br>
Logcat に出力されたトークンをコピーしておきます。</p>
<h2 id="4.-%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%92%E9%80%81%E3%81%A3%E3%81%A6%E3%80%81%E5%8F%97%E4%BF%A1%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">4. メッセージを送って、受信してみる <a class="direct-link" href="#4.-%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%92%E9%80%81%E3%81%A3%E3%81%A6%E3%80%81%E5%8F%97%E4%BF%A1%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">#</a></h2>
<p>Android アプリは起動しっぱなしにしておいてください、とりあえず。</p>
<p><a href="https://console.firebase.google.com/">https://console.firebase.google.com/</a> からプロジェクト「FcmSample」を開き、「Notification」の「使ってみる」をクリックします（なんか別途 「Cloud Messaging」もありますがトラップ？）。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/4cdb45b4-8ef7-b950-bac2-4115040335bd.png" alt="image.png"></p>
<p>さらに「最初のメッセージを送信する」をクリックして、</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/8a3ca86b-a07d-e028-6629-022c390445fa.png" alt="image.png"></p>
<p>のように設定します。<br>
ターゲットは「単一の端末」にして、トークンの欄にコピーしておいた文字列を貼り付けます。</p>
<p>で、「メッセージ送信」を押すと、ただちにメッセージが送信され、起動させておいた Androidアプリの <code>MyFirebaseMessagingService</code> が受信して、次のようなログを出力します。</p>
<pre><code>D/FCM-TEST: メッセージタイプ: 通知
    タイトル: 
    本文: はろー
</code></pre>
<h2 id="5.-firebase-%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E6%9C%80%E6%96%B0%E3%81%AB%E3%81%99%E3%82%8B">5. Firebase のライブラリを最新にする <a class="direct-link" href="#5.-firebase-%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E6%9C%80%E6%96%B0%E3%81%AB%E3%81%99%E3%82%8B">#</a></h2>
<ol start="2">
<li>で追加された Firebase のライブラリのバージョンは 11.8.0 でしたが、2018年6月現在の最新は <strong>17.0.0</strong> です。</li>
</ol>
<p>ので <code>app/build.gradle</code> に記述されているバージョンを <strong>17.0.0</strong> に変更して「Sync now」します。</p>
<p>すると見事に <strong>Failed to resolve: com.google.firebase:firebase-core:17.0.0</strong> というエラーになります。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/262c7f9c-fcfa-3f3e-446f-febffca87395.png" alt="image.png"></p>
<p>小一時間ほど消費していろいろ調べた結果、最終行の <code>apply plugin: 'com.google.gms.google-services'</code> が無ければエラーにならない、ことが判りました（ついでに Warning されてた &quot;Configulation 'compile' is obsolete and ...&quot; も出なくなります）。</p>
<p><code>apply plugin: 'com.google.gms.google-services'</code> は、</p>
<ul>
<li><a href="https://developers-jp.googleblog.com/2017/04/take-control-of-your-firebase-init-on.html">Google Developers Japan: Android での Firebase の初期化を使いこなす</a></li>
</ul>
<p>によると、 <code>google-services.json</code> からプロジェクト情報を読み込んで、自動的にアプリに設定してくれるプラグイン、であると理解できます。<br>
オーケー、ここで全部削除して設定は手動で行いましょう。</p>
<p><strong>com.google.gms.google-services を削除した <code>app/build.gradle</code>:</strong></p>
<pre><code>apply plugin: 'com.android.application'

apply plugin: 'kotlin-android'

apply plugin: 'kotlin-android-extensions'

android {
    compileSdkVersion 27
    defaultConfig {
        applicationId &quot;net.yourdomain.fcmsample&quot;
        minSdkVersion 23
        targetSdkVersion 27
        versionCode 1
        versionName &quot;1.0&quot;
        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation &quot;org.jetbrains.kotlin:kotlin-stdlib-jre7:$kotlin_version&quot;
    implementation 'com.android.support:appcompat-v7:27.1.1'
    implementation 'com.android.support.constraint:constraint-layout:1.1.0'
    implementation 'com.google.firebase:firebase-messaging:17.0.0'
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'com.android.support.test:runner:1.0.2'
    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'
}
</code></pre>
<p><strong>com.google.gms.google-services を削除したルートの <code>build.gradle</code>:</strong></p>
<pre><code>// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    ext.kotlin_version = '1.2.41'
    repositories {
        google()
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:3.1.2'
        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;
    }
}

allprojects {
    repositories {
        google()
        jcenter()
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
</code></pre>
<p><code>google-services.json</code> から自動で読み込まれていた設定を手動で行うには、<code>FirebaseApp.initializeApp(Context, FirebaseOptions)</code> を起動時に呼び出します。<code>android.app.Application</code> クラスを拡張した <code>MyApplication</code> クラスを作って、 <code>onCreate</code> で行うのが一般的でしょう。<strong><code>MyApplication</code> を <code>AndroidManifest.xml</code> へ追加するのを忘れずに</strong></p>
<p>ちなみに <code>FirebaseApp.initializeApp</code> の呼び出しがされないと、<code>FirebaseInstanceId.getInstance()</code> を使用したときに、</p>
<pre><code>Default FirebaseApp is not initialized in this process net.yourdomain.fcmsample. Make sure to call FirebaseApp.initializeApp(Context) first.
</code></pre>
<p>という例外がでます。</p>
<p>FCM を使うだけなら、次のように「ApplicationID」と「APIKey」を設定すればよいようです。</p>
<p><strong>Firebaseの初期化を行う <code>MyApplication.kt</code>:</strong></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">package</span> net<span class="token punctuation">.</span>yourdomain<span class="token punctuation">.</span>fcmsample<br><br><span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Application<br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>FirebaseApp<br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>FirebaseOptions<br><br><span class="token keyword">class</span> MyApplication <span class="token operator">:</span> <span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>        FirebaseApp<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> FirebaseOptions<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">setApplicationId</span><span class="token punctuation">(</span><span class="token string">"&lt;application_id>"</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">setApiKey</span><span class="token punctuation">(</span><span class="token string">"&lt;api_key>"</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>「ApplicationID」と「APIKey」は <code>google-services.json</code> にも記述されていますが、それに頼らず Firebase のサイトからも確認できます。</p>
<p><a href="https://console.firebase.google.com/">https://console.firebase.google.com/</a> からプロジェクト「FcmSample」を開き、Project Overview → プロジェクトの設定 で表示されます。</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/8227/51dcfd8e-7ba7-c589-875a-1dccb45b6436.png" alt="image.png"></p>
<p>サイトから得た「ApplicationID」と「APIKey」をソースコードにベタ貼りすると、それもよくないので、外出ししましょう。</p>
<p>いくつか方法がありますが、</p>
<ul>
<li><a href="https://developer.android.com/studio/build/gradle-tips#share-custom-fields-and-resource-values-with-your-app-code">Gradle tips and recipes｜Android Developers</a></li>
<li><a href="https://docs.microsoft.com/en-us/appcenter/build/custom/variables/#buildgradle-for-android">Environment Variables - Visual Studio App Center | Microsoft Docs</a></li>
<li><a href="https://qiita.com/tmiyamon/items/ed660dff7846f5ec95d3">AndroidStudioに環境変数を渡す - Qiita</a></li>
</ul>
<p>に従ってみます。<br>
この仕組みは、</p>
<p>A. システム環境変数に APP_ID と API_KEY を作成する<br>
B. gradle を使って、 <strong>ビルド時</strong> に、1. の値をソースコード(の <code>BuildConfig</code> クラス)に埋め込む<br>
C. 実装は <code>BuildConfig.APP_ID</code>, <code>BuildConfig.API_KEY</code> を使う</p>
<p>です。</p>
<h3 id="a.-%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%81%AB-app_id-%E3%81%A8-api_key-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">A. システム環境変数に APP_ID と API_KEY を作成する <a class="direct-link" href="#a.-%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%81%AB-app_id-%E3%81%A8-api_key-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">#</a></h3>
<p>mac の Terminal だと <code>launchctl setenv</code> を使います。<br>
環境変数名はプロジェクト名を接頭辞にして <code>FCMSAMPLE_APP_ID</code>、<code>FCMSAMPLE_API_KEY</code> としました。</p>
<pre><code>launchctl setenv FCMSAMPLE_APP_ID 1:7618378357:android:70bef98060071fe6
launchctl setenv FCMSAMPLE_API_KEY xxxxxxxx
</code></pre>
<p>こんな感じで。<br>
<strong>実行後、Android Studio を再起動します</strong>。しないと環境設定値が反映されませんでした。</p>
<h3 id="b.-gradle-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%80%81buildconfig-%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80">B. gradle を使って、<code>BuildConfig</code> クラスに埋め込む <a class="direct-link" href="#b.-gradle-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%80%81buildconfig-%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80">#</a></h3>
<p><code>app/build.gradle</code> を次のように編集し、<code>FCMSAMPLE_APP_ID</code>、<code>FCMSAMPLE_API_KEY</code> を埋め込みます。</p>
<p><strong>環境変数を埋め込んだ <code>app/build.gradle</code>:</strong></p>
<pre><code>apply plugin: 'com.android.application'

apply plugin: 'kotlin-android'

apply plugin: 'kotlin-android-extensions'

android {
    compileSdkVersion 27
    defaultConfig {
        applicationId &quot;net.yourdomain.fcmsample&quot;
        minSdkVersion 23
        targetSdkVersion 27
        versionCode 1
        versionName &quot;1.0&quot;
        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;
    }
    buildTypes {
        debug {
            buildConfigField(&quot;String&quot;, &quot;APP_ID&quot;, &quot;\&quot;${System.env.FCMSAMPLE_APP_ID}\&quot;&quot;)
            buildConfigField(&quot;String&quot;, &quot;API_KEY&quot;, &quot;\&quot;${System.env.FCMSAMPLE_API_KEY}\&quot;&quot;)
        }
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            buildConfigField(&quot;String&quot;, &quot;APP_ID&quot;, &quot;\&quot;${System.env.FCMSAMPLE_APP_ID}\&quot;&quot;)
            buildConfigField(&quot;String&quot;, &quot;API_KEY&quot;, &quot;\&quot;${System.env.FCMSAMPLE_API_KEY}\&quot;&quot;)
        }
    }
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation &quot;org.jetbrains.kotlin:kotlin-stdlib-jre7:$kotlin_version&quot;
    implementation 'com.android.support:appcompat-v7:27.1.1'
    implementation 'com.android.support.constraint:constraint-layout:1.1.0'
    implementation 'com.google.firebase:firebase-messaging:17.0.0'
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'com.android.support.test:runner:1.0.2'
    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'
}
</code></pre>
<p><code>buildTypes</code> に <code>buildConfigField(&quot;String&quot;, &quot;APP_ID&quot;, &quot;\&quot;${System.env.FCMSAMPLE_APP_ID}\&quot;&quot;)</code> などを追記しています。注意点は、<code>String</code> は大文字(Javaのクラス名なので)にすること、第二引数が文字列なら <code>\&quot;</code> で囲むこと、です。特に後者を忘れると、ダブルコートなしの文字列リテラルが埋め込まれてエラーになります。</p>
<h3 id="c.-%E5%AE%9F%E8%A3%85%E3%81%AF-buildconfig.app_id%2C-buildconfig.api_key-%E3%82%92%E4%BD%BF%E3%81%86">C. 実装は <code>BuildConfig.APP_ID</code>, <code>BuildConfig.API_KEY</code> を使う <a class="direct-link" href="#c.-%E5%AE%9F%E8%A3%85%E3%81%AF-buildconfig.app_id%2C-buildconfig.api_key-%E3%82%92%E4%BD%BF%E3%81%86">#</a></h3>
<p>最後に、この buildConfig を使用するように <code>MyApplication.kt</code> を変更します。</p>
<p><strong>BuildConfigを使用するように変更した MyApplication.kt:</strong></p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">package</span> net<span class="token punctuation">.</span>yourdomain<span class="token punctuation">.</span>fcmsample<br><br><span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Application<br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>FirebaseApp<br><span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>firebase<span class="token punctuation">.</span>FirebaseOptions<br><br><span class="token keyword">class</span> MyApplication <span class="token operator">:</span> <span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>        FirebaseApp<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> FirebaseOptions<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">setApplicationId</span><span class="token punctuation">(</span>BuildConfig<span class="token punctuation">.</span>APP_ID<span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">setApiKey</span><span class="token punctuation">(</span>BuildConfig<span class="token punctuation">.</span>API_KEY<span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>手順が成功していれば、<code>BuildConfig.APP_ID</code> や <code>BuildConfig.API_KEY</code> には、A. で設定した環境変数の値が入っているはずです。失敗していれば <code>null</code> になります。</p>
<p>この仕組みは大抵の CIサービスでも対応しているので、リリース時には CIサービス の設定で環境変数を設定してあげれば埋め込まれるはずです。</p>
<h2 id="databinding%E3%80%81kapt%2C-coroutine%2C-aac%2C-support-libs-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">DataBinding、kapt, coroutine, AAC, Support Libs を追加する <a class="direct-link" href="#databinding%E3%80%81kapt%2C-coroutine%2C-aac%2C-support-libs-%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">#</a></h2>
<p>ここまで来たらやってしまえ、ということで</p>
<ul>
<li>DataBinding</li>
<li>kapt</li>
<li>Kotlin coroutine - 0.22.5</li>
<li>Android Architecture Components(AAC) - 1.1.0 〜 1.1.1</li>
<li>Android Support Library - 27.1.1</li>
</ul>
<p>も追加してみた。</p>
<p><strong>諸々追加した <code>app/build.gradle</code>:</strong></p>
<pre><code>apply plugin: 'com.android.application'

apply plugin: 'kotlin-android'

apply plugin: 'kotlin-android-extensions'

apply plugin: 'kotlin-kapt'

android {
    compileSdkVersion 27
    defaultConfig {
        applicationId &quot;net.yourdomain.fcmsample&quot;
        minSdkVersion 23
        targetSdkVersion 27
        versionCode 1
        versionName &quot;1.0&quot;
        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;
    }
    buildTypes {
        debug {
            buildConfigField(&quot;String&quot;, &quot;APP_ID&quot;, &quot;\&quot;${System.env.FCMSAMPLE_APP_ID}\&quot;&quot;)
            buildConfigField(&quot;String&quot;, &quot;API_KEY&quot;, &quot;\&quot;${System.env.FCMSAMPLE_API_KEY}\&quot;&quot;)
        }
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            buildConfigField(&quot;String&quot;, &quot;APP_ID&quot;, &quot;\&quot;${System.env.FCMSAMPLE_APP_ID}\&quot;&quot;)
            buildConfigField(&quot;String&quot;, &quot;API_KEY&quot;, &quot;\&quot;${System.env.FCMSAMPLE_API_KEY}\&quot;&quot;)
        }
    }

    dataBinding {
        enabled = true
    }
}

dependencies {
    kapt 'com.android.databinding:compiler:3.1.2'

    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation &quot;org.jetbrains.kotlin:kotlin-stdlib-jre7:$kotlin_version&quot;

    def coroutines_version = '0.22.5'
    implementation &quot;org.jetbrains.kotlinx:kotlinx-coroutines-core:$coroutines_version&quot;
    implementation &quot;org.jetbrains.kotlinx:kotlinx-coroutines-android:$coroutines_version&quot;

    // Android Support Libraries
    implementation 'com.android.support:design:27.1.1'
    implementation 'com.android.support:appcompat-v7:27.1.1'
    implementation 'com.android.support:cardview-v7:27.1.1'
    implementation 'com.android.support.constraint:constraint-layout:1.1.0'

    // AAC
    implementation 'android.arch.lifecycle:extensions:1.1.1'
    implementation 'android.arch.persistence.room:runtime:1.1.0'
    annotationProcessor &quot;android.arch.lifecycle:compiler:1.1.1&quot;
    annotationProcessor &quot;android.arch.persistence.room:compiler:1.1.0&quot;

    // FCM
    implementation 'com.google.firebase:firebase-messaging:17.0.0'

    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'com.android.support.test:runner:1.0.2'
    androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.2'
}
</code></pre>
<p>とりあえずエラーにはならなかったので、依存関係のトラブルは大丈夫みたいです。</p>
<h2 id="%E6%9C%80%E5%BE%8C%E3%81%AB">最後に <a class="direct-link" href="#%E6%9C%80%E5%BE%8C%E3%81%AB">#</a></h2>
<p>プロジェクト全体は</p>
<ul>
<li><a href="https://github.com/amay077/FcmSample201806">https://github.com/amay077/FcmSample201806</a></li>
</ul>
<p>に。</p>


published at <time class="postlist-date" datetime="2018-06-06">06 Jun 2018</time>

tags: 

  <a href="/tags/Android/" class="post-tag">Android</a>
  <a href="/tags/Kotlin/" class="post-tag">Kotlin</a>
  <a href="/tags/Firebase/" class="post-tag">Firebase</a>

<hr>
<ul><li>Next: <a href="/blog/2018/06/15/8823376f307235a7f651/">プロダクトのドキュメントにプルリクエストを送れる仕組みがすごい</a></li><li>Previous: <a href="/blog/2018/05/24/d4629f9d20ba36a1347e/">MV* の「つなぎ」に RxJava を使うのをやめたい</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /blog/2018/06/06/3e6e00c1b45fa5e37b5d/ -->
  </body>
</html>
